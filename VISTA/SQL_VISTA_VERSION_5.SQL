
CREATE OR REPLACE FORCE VIEW PENDUPM.VIEW_GASTO_TEST

AS
   SELECT  
            -- DATOS DE LA TABLA GASTOS 
              G.IDGASTO AS Numero_de_caso
            , COL.CLNAME AS Solicitante
            , (CASE WHEN AUTORIZADOR.NMNOMBRE IS NULL THEN 'S/A' WHEN LENGTH(AUTORIZADOR.NMNOMBRE) > 0 THEN AUTORIZADOR.NMNOMBRE  END) AS AUTORIZADOR
            , MOT.NMMOTIVOGASTO AS MOTIVO_GASTO
            , G.FDFECREGISTRO AS FECHA_SOLICITUD
            , G.FDAPROBADO AS FECHA_APROBACION
            , G.FDFECINI AS FECHA_INICIO
            , G.FDFECFIN AS  FECHA_FIN  
            , (CASE WHEN G.FCVIATICO0  = 'S' THEN 'CERO' WHEN (G.FCVIATICO0 = 'N' OR  G.FCVIATICO0 IS NULL  )  THEN 'NORMAL' END) AS TIPO_PLAN_VIAJE
            , (CASE WHEN G.FCURGENTE   = 'S'  THEN 'SI' WHEN (G.FCURGENTE = 'N' OR  G.FCURGENTE IS NULL )    THEN 'NO' END) AS URGENTE
            ,  DECODE( TRIM(G.FCSTATUS)
                        ,'R','Registrado'
                        ,'P','Pendiente de Autorización'
                        ,'A','Autorizado'
                        ,'G','En comprobacin'
                        ,'C','Comprobada'
                        ,'V','Comprobación Validada'
                        ,'D','Deposito de viaticos'
                        ,'F','Finalizado'
                        ,'Z','Cancelado', '') AS Estatus
           
            , (CASE WHEN G.FNMONTOGASTO IS NULL OR  G.FNMONTOGASTO = 0 THEN '0.00' WHEN G.FNMONTOGASTO > 0 THEN ' ' ||  G.FNMONTOGASTO END) AS Monto_Solicitado
            , (CASE WHEN ( (G.FNMONTOCOMPROBADO - G.FNMONTOGASTO ) IS NULL OR  (G.FNMONTOCOMPROBADO - G.FNMONTOGASTO ) = 0 )     THEN ' 0.00' WHEN (G.FNMONTOCOMPROBADO - G.FNMONTOGASTO ) > 0 THEN ' ' || (G.FNMONTOCOMPROBADO - G.FNMONTOGASTO ) END) AS Saldo_Favor
            , (G.FDFECFIN-G.FDFECINI) AS DIAS_DE_VIAJE 
            
    
           -- , (CASE WHEN (G.FDFECINIRENTA IS NULL AND FDDYNAMICSGAS IS NOT NULL ) THEN 'PROPIO' WHEN G.FDFECINIRENTA IS NOT NULL THEN 'RENTADO' END) Tipo_de_transporte
            
            
            , (CASE

                When (G.FDFECINIRENTA IS NULL AND FDDYNAMICSGAS IS NOT NULL ) THEN 'PROPIO'

                When (G.FDFECINIRENTA IS NOT NULL AND FDDYNAMICSGAS IS NOT NULL ) THEN 'RENTADO'

                Else 'NINGUNO'

                END) AS Tipo_de_transporte
                            
             -- CONCEPTO DE GASOLINAS 
            
            , (CASE WHEN (DETG6.FNIMPORTE  IS NULL OR DETG6.FNIMPORTE = 0) AND (DETG6.FCCONCEPTO = 'alimento' ) THEN ' 0.00' WHEN  (DETG6.FNIMPORTE > 0 AND DETG6.FCCONCEPTO = 'alimento' )  THEN ' ' ||  DETG6.FNIMPORTE   END) AS ALIMENTOS
            , (CASE WHEN (DETG5.FNIMPORTE  IS NULL OR DETG5.FNIMPORTE = 0) AND (DETG5.FCCONCEPTO = 'hospedaje' ) THEN ' 0.00' WHEN  (DETG5.FNIMPORTE > 0 AND DETG5.FCCONCEPTO = 'hospedaje' )  THEN ' ' ||  DETG5.FNIMPORTE   END) AS HOSPEDAJE
            
            , (CASE WHEN (DETG4.FNIMPORTE  IS NULL OR DETG4.FNIMPORTE = 0) AND (DETG4.FCCONCEPTO = 'autobus' ) THEN ' 0.00' WHEN  (DETG4.FNIMPORTE > 0 AND DETG4.FCCONCEPTO = 'autobus' )  THEN ' ' ||  DETG4.FNIMPORTE   END) AS AUTOBUS
            , (CASE WHEN (DETG2.FNIMPORTE  IS NULL OR DETG2.FNIMPORTE = 0) AND (DETG2.FCCONCEPTO = 'taxis' ) THEN ' 0.00' WHEN  (DETG2.FNIMPORTE > 0 AND DETG2.FCCONCEPTO = 'taxis' )  THEN ' ' ||  DETG2.FNIMPORTE   END) AS TAXIS
            
            , (CASE WHEN (DETG1.FNIMPORTE  IS NULL OR DETG1.FNIMPORTE = 0) AND (DETG1.FCCONCEPTO = 'gasolina' ) THEN ' 0.00' WHEN  (DETG1.FNIMPORTE > 0 AND DETG1.FCCONCEPTO = 'gasolina' )  THEN ' ' ||  DETG1.FNIMPORTE   END) AS GASOLINA
            , (CASE WHEN (DETG7.FNIMPORTE  IS NULL OR DETG7.FNIMPORTE = 0) AND (DETG7.FCCONCEPTO = 'desgaste' ) THEN ' 0.00' WHEN  (DETG7.FNIMPORTE > 0 AND DETG7.FCCONCEPTO = 'desgaste' )  THEN ' ' ||  DETG7.FNIMPORTE   END) AS DESGASTE_VEHICULO
            
            , (CASE WHEN (DETG3.FNIMPORTE  IS NULL OR DETG3.FNIMPORTE = 0) AND (DETG3.FCCONCEPTO = 'casetas' ) THEN ' 0.00' WHEN  (DETG3.FNIMPORTE > 0 AND DETG3.FCCONCEPTO = 'casetas' )  THEN ' ' ||  DETG3.FNIMPORTE   END) AS CASETAS
            , (CASE WHEN (DETG8.FNIMPORTE  IS NULL OR DETG8.FNIMPORTE = 0) AND (DETG8.FCCONCEPTO = 'adicional' ) THEN ' 0.00' WHEN  (DETG8.FNIMPORTE > 0 AND DETG8.FCCONCEPTO = 'adicional' )  THEN ' ' ||  DETG8.FNIMPORTE   END) AS IMPORTE_ADICIONAL
            
            
           , (DETG1.FNIMPORTE + DETG2.FNIMPORTE + DETG3.FNIMPORTE + DETG4.FNIMPORTE + DETG5.FNIMPORTE + DETG6.FNIMPORTE + DETG7.FNIMPORTE +  DETG8.FNIMPORTE ) AS IMPORTE_VIATICOS
           , (CASE WHEN G.FNMONTOGASTO IS NULL OR  G.FNMONTOGASTO = 0 THEN '0.00' WHEN G.FNMONTOGASTO > 0 THEN ' ' ||  G.FNMONTOGASTO END) AS IMPORTE_A_COMPROBAR         

            , G.FDCONTABILIZA AS FECHA_CONTABILIDAD
            , G.FNEMPNOMINA AS FECHA_NOMINA
            , G.FDDYNAMICSVIATICOS AS PAGO_VIATICOS
            , G.FDDYNAMICSGAS AS PAGO_GASOLINA
            , G.FDDYNAMICSVIATICOSCONF AS CONFIRMACION_PAGO
            , G.FDFECINIRENTA FECHA_RENTA_CARRO
             
             , (SELECT CARD.FCNOCARD FROM PENDUPM.CTCARDMAIN CARD WHERE CARD.IDEJEC = (SELECT A2.CLIDNUM FROM PENDUPM.GASTOMAIN A1 
                LEFT JOIN RCVRY.COLLID A2 ON A2.CLCOLLID = A1.IDSOLICITANTE
                WHERE A1.IDGASTO = G.IDGASTO) AND CARD.FCTIPO = 'G' AND FCSTATUS = 'A') AS NUM_CARD
          
            , ( SELECT CARD.FCREFERENCIA FROM PENDUPM.CTCARDMAIN CARD WHERE CARD.IDEJEC = (SELECT A2.CLIDNUM FROM PENDUPM.GASTOMAIN A1 
                LEFT JOIN RCVRY.COLLID A2 ON A2.CLCOLLID = A1.IDSOLICITANTE
                WHERE A1.IDGASTO = G.IDGASTO) AND CARD.FCTIPO = 'G' AND FCSTATUS = 'A') AS REFERENCIA_CARD

            , ( SELECT CARD.FCBANCO FROM PENDUPM.CTCARDMAIN CARD WHERE CARD.IDEJEC = (SELECT A2.CLIDNUM FROM PENDUPM.GASTOMAIN A1 
                LEFT JOIN RCVRY.COLLID A2 ON A2.CLCOLLID = A1.IDSOLICITANTE
                WHERE A1.IDGASTO = G.IDGASTO) AND CARD.FCTIPO = 'G' AND FCSTATUS = 'A')  AS BANCO_CARD
  
  
        FROM PENDUPM.GASTOMAIN G 
            LEFT JOIN RCVRY.COLLID  COL ON G.IDSOLICITANTE=COL.CLCOLLID 
            LEFT JOIN PENDUPM.CTMOTIVOGASTO MOT ON G.IDMOTIVOGASTO=MOT.IDMOTIVOGASTO

            LEFT JOIN (SELECT IDGASTO, FCCONCEPTO, SUM(FNIMPORTE) AS FNIMPORTE  FROM (SELECT DISTINCT IDGASTO, FCCONCEPTO,FNIMPORTE FROM PENDUPM.DETALLEGASTO WHERE FCCONCEPTO = 'gasolina') GROUP BY IDGASTO, FCCONCEPTO) DETG1 ON DETG1.IDGASTO = G.IDGASTO
            LEFT JOIN (SELECT IDGASTO, FCCONCEPTO, SUM(FNIMPORTE) AS FNIMPORTE  FROM (SELECT DISTINCT IDGASTO, FCCONCEPTO,FNIMPORTE FROM PENDUPM.DETALLEGASTO WHERE FCCONCEPTO = 'taxis') GROUP BY IDGASTO, FCCONCEPTO) DETG2 ON DETG2.IDGASTO = G.IDGASTO
                         
            LEFT JOIN (SELECT IDGASTO, FCCONCEPTO, SUM(FNIMPORTE) AS FNIMPORTE  FROM (SELECT DISTINCT IDGASTO, FCCONCEPTO,FNIMPORTE FROM PENDUPM.DETALLEGASTO WHERE FCCONCEPTO = 'casetas') GROUP BY IDGASTO, FCCONCEPTO) DETG3 ON DETG3.IDGASTO = G.IDGASTO
            LEFT JOIN (SELECT IDGASTO, FCCONCEPTO, SUM(FNIMPORTE) AS FNIMPORTE  FROM (SELECT DISTINCT IDGASTO, FCCONCEPTO,FNIMPORTE FROM PENDUPM.DETALLEGASTO WHERE FCCONCEPTO = 'autobus') GROUP BY IDGASTO, FCCONCEPTO) DETG4 ON DETG4.IDGASTO = G.IDGASTO

            LEFT JOIN (SELECT IDGASTO, FCCONCEPTO, SUM(FNIMPORTE) AS FNIMPORTE  FROM (SELECT DISTINCT IDGASTO, FCCONCEPTO,FNIMPORTE FROM PENDUPM.DETALLEGASTO WHERE FCCONCEPTO = 'hospedaje') GROUP BY IDGASTO, FCCONCEPTO) DETG5 ON DETG5.IDGASTO = G.IDGASTO
            LEFT JOIN (SELECT IDGASTO, FCCONCEPTO, SUM(FNIMPORTE) AS FNIMPORTE  FROM (SELECT DISTINCT IDGASTO, FCCONCEPTO,FNIMPORTE FROM PENDUPM.DETALLEGASTO WHERE FCCONCEPTO = 'alimento') GROUP BY IDGASTO, FCCONCEPTO) DETG6 ON DETG6.IDGASTO = G.IDGASTO
 
            LEFT JOIN (SELECT IDGASTO, FCCONCEPTO, SUM(FNIMPORTE) AS FNIMPORTE  FROM (SELECT DISTINCT IDGASTO, FCCONCEPTO,FNIMPORTE FROM PENDUPM.DETALLEGASTO WHERE FCCONCEPTO = 'desgaste') GROUP BY IDGASTO, FCCONCEPTO) DETG7 ON DETG7.IDGASTO = G.IDGASTO
            LEFT JOIN (SELECT IDGASTO, FCCONCEPTO, SUM(FNIMPORTE) AS FNIMPORTE  FROM (SELECT DISTINCT IDGASTO, FCCONCEPTO,FNIMPORTE FROM PENDUPM.DETALLEGASTO WHERE FCCONCEPTO = 'adicional') GROUP BY IDGASTO, FCCONCEPTO) DETG8 ON DETG8.IDGASTO = G.IDGASTO
                        
            LEFT JOIN ( SELECT IDGASTO,  LISTAGG (NMNOMBRE, '/') WITHIN GROUP (ORDER BY IDGASTO) NMNOMBRE FROM (SELECT  NMNOMBRE,  IDGASTO FROM PENDUPM.PLANDEVIAJEBITACORA B   INNER JOIN PENDUPM.CTUSUARIOS C ON B.FCUSUARIO=C.FCEMAIL   WHERE  IDTASK = '58330755250576e173db313032467847' GROUP BY NMNOMBRE, IDGASTO) GROUP BY  IDGASTO ) AUTORIZADOR ON AUTORIZADOR.IDGASTO = G.IDGASTO 
                           
     -- WHERE G.FCSTATUS NOT IN ('R', 'Z', 'P')  
       
      ORDER BY G.IDGASTO DESC;

GRANT SELECT ON PENDUPM.VIEW_GASTO_TEST TO PM_OPER;