-- PASO 1 pv 2017 ESTATUS FINALZIADOS SEAN AVION Y AUTO
-- LA FECHA DE REGISTRO 


-- PASO 2 NUMERO DE GASTO ASOCIADO DEL UNIVERSO 5700 CONFIRMAR MONTOS, gastos deben consultar por su estatus finalizados  
-- ID PLAN VIAJE, FECHA REGISTRO, CONCEPTO, MONTO PLAN DE VIAJE, NUMMERODElote, IDFACTURACION (GASTOS), MONTO DE LA FACTURACION.  BI GASTO, BI MONTO, BIAVION, BIAUTO 

-- error 


----------------------------------------------------

-- CREAR DOS TABLAS DE DYNAMIC USANDO EL CREATE TABLE (SELECT )
-- bUSCAR RELACION ENTRE GASTOS TABLA A Y B   Campo de referencia  

-- PASO 1 


CREATE TABLE PENDUPM.TEMP_CONCILIACION
(
  ID_CONSOLIDACION  INTEGER,
  ID_PLANVIAJE      INTEGER,
  FDFECREGISTRO     DATE,
  MONTO_PV          FLOAT,
  ID_FACTURACION    INTEGER,
  MONTO_GASTO       FLOAT,
  BI_IDGASTO        INTEGER,
  BI_CONCEPTO       INTEGER,
  BI_MONTO          FLOAT
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
NOMONITORING;


ALTER TABLE PENDUPM.TEMP_CONCILIACION ADD (
  CONSTRAINT TEMP_CONCILIACION_PK
 PRIMARY KEY
 (ID_CONSOLIDACION));

 GRANT SELECT ON PENDUPM.TEMP_CONCILIACION TO COMERCIAL_OPER;

GRANT SELECT ON PENDUPM.TEMP_CONCILIACION TO ODI;

GRANT SELECT ON PENDUPM.TEMP_CONCILIACION TO OPERACION WITH GRANT OPTION;

GRANT DELETE, INSERT, SELECT, UPDATE ON PENDUPM.TEMP_CONCILIACION TO PM_OPER;

GRANT DELETE, INSERT, SELECT, UPDATE ON PENDUPM.TEMP_CONCILIACION TO TL_PM;



-- PASO 2 

CREATE SEQUENCE PENDUPM.SEQ_TEMP_CONCILIACION
  START WITH 1
  MAXVALUE 999999999999999999
  MINVALUE 0
  NOCYCLE
  NOCACHE
  NOORDER;
  
GRANT SELECT ON PENDUPM.SEQ_TEMP_CONCILIACION TO COMERCIAL_OPER;

GRANT SELECT ON PENDUPM.SEQ_TEMP_CONCILIACION TO ODI;

GRANT SELECT ON PENDUPM.SEQ_TEMP_CONCILIACION TO OPERACION WITH GRANT OPTION;

GRANT  SELECT ON PENDUPM.SEQ_TEMP_CONCILIACION TO PM_OPER;

GRANT  SELECT ON PENDUPM.SEQ_TEMP_CONCILIACION TO TL_PM;


-- PASO 3 

INSERT INTO PENDUPM.TEMP_CONCILIACION

SELECT PENDUPM.SEQ_TEMP_CONCILIACION.NEXTVAL, 
 GM.IDGASTO AS ID_PLANVIAJE
, TO_CHAR(GM.FDFECREGISTRO, 'dd/mm/yyyy') AS FDFECREGISTRO
, GM.FNMONTOGASTO
, FA.IDGASTOMAIN          
, FA.FNIMPORTECOMPROBA
, BI.SOLICITUD 
, BI.CONCEPTO 
, BI.TOTALCOMP  

FROM PENDUPM.GASTOMAIN GM  
LEFT JOIN PENDUPM.FACTURAASIGNACION FA ON FA.IDPLANVIAJE = GM.IDGASTO
LEFT JOIN PENDUDW.GASTOS_TMP_LAYOUT@pendubi.com BI ON BI.SOLICITUD = FA.IDGASTOMAIN   

WHERE TO_CHAR(GM.FDFECREGISTRO, 'yyyy/mm/dd') >= '2017/01/01' 
AND GM.FCSTATUS = 'F'
AND GM.FDFECINIRENTA IS NOT NULL;


-- PASO 4

create table pendupm.GLTRAN as ( 
select *       
  FROM GLTRAN@ERPBASE.COM A
  )
  
  CREATE INDEX PENDUPM.INDEX_BATBNR ON PENDUPM.GLTRAN
("BatNbr")
LOGGING
NOPARALLEL
COMPUTE STATISTICS;
  
  
-- PASO 5
  
 -- DROP TABLE PENDUPM.xAddDev;
  
  create table pendupm.xAddDev as ( 
select *    
  FROM xAddDev@ERPBASE.COM A
  ) 

  
create table pendupm.xtravelfieldhdr as ( 
select *       
FROM xtravelfieldhdr@erpbase.com  A
);

  
  
	  
-- PASO 6 

CREAR TABLA 


CREATE TABLE PENDUPM.TEMP_CONCILIACION_RESUMEN
(
  ID_CONSOLIDACION_RESUMEN  INTEGER,
  ID_PLANVIAJE      INTEGER,
  FDFECREGISTRO     DATE,
  MONTO_PV          FLOAT,
  ID_FACTURACION    INTEGER,
  MONTO_GASTO       FLOAT,
  BI_IDGASTO        INTEGER,
  BI_CONCEPTO       INTEGER,
  BI_MONTO          FLOAT
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
NOMONITORING;




-- PASO 7
SELECT DISTINCT A.*, B."LineId", C."CrAmt", C."CuryCrAmt", C."BatNbr"  
FROM PENDUPM.TEMP_CONCILIACION A 
INNER JOIN PENDUPM.xAddDev B ON A.ID_PLANVIAJE = B."LineId" 
INNER JOIN PENDUPM.GLTRAN C ON B."BatNbr" = C."BatNbr"
WHERE B."LineId" = '4305039'




--------------
select count(*) from (


--create  table pendupm.iaal as (
--3090  --2558
select com.IDGASTO ,
gas.FDFECINI,gas.FDFECFIN,gas.FDFECREGISTRO,gas.IDSOLICITANTE,
gas.FCSTATUS,gas.FNEMPNOMINA,gas.FCURGENTE,gas.FCVIATICO0,
sum(com.FNIMPORTE) FV_FNIMPORTE,sum(com.FNTOTAL) FV_FNTOTAL,  con.NMCONCEPTO ,
sum(fa.FNIMPORTECOMPROBA) GA_FNIMPORTECOMPROBA --, com.IDTPOGASTO
,FA.IDGASTOMAIN ga_IDGASTOMAIN  
,BI.IMPORTESOLICITUD BI_IMPORTESOLICITUD ,BI.IMPORTEFACTURACION BI_IMPORTEFACTURACION
,xt."BatNbr" xt_BatNbr
FROM PENDUPM.GASTOMAIN Gas  ,PENDUPM.comprobaciongasto com, PENDUPM.conceptogasto con,pendupm.facturaasignacion fa
,GASTOS_TMP_LAYOUT@pendubi.com BI ,
pendupm.xtravelfieldhdr xt
where gas.idgasto = com.idgasto
and com.IDTPOGASTO = con.IDTPOGASTO
and com.IDCONCEPTO = con.IDCONCEPTO
AND FA.IDCONCEPTO = bI.CONCEPTO1
AND FA.IDGASTOMAIN = BI.SOLICITUD (+)
and FA.IDGASTOMAIN = to_number(xt."ReqNbr")
and gas.FCSTATUS = 'F'
and com.IDTPOGASTO  in (7,8)  --7,8
and gas.FDFECREGISTRO >= to_Date ( '2017/01/01' ,'yyyy/MM/dd')
and gas.idgasto =  fa.IDPLANVIAJE (+)
--and com.idgasto =:pv
group by com.IDGASTO ,FA.IDGASTOMAIN,
gas.FDFECINI,gas.FDFECFIN,gas.FDFECREGISTRO,gas.IDSOLICITANTE,
gas.FCSTATUS,gas.FNEMPNOMINA,gas.FCURGENTE,gas.FCVIATICO0,  con.NMCONCEPTO,com.IDTPOGASTO
,IMPORTESOLICITUD,IMPORTEFACTURACION,xt."BatNbr"

)
-
--------------------


select count(*) from (


--create  table pendupm.iaal as (
--3090  --2558
select
gas.IDGASTO ,gas.FDFECINI,gas.FDFECFIN,gas.FDFECREGISTRO,gas.IDSOLICITANTE,gas.FCSTATUS,gas.FNEMPNOMINA,gas.FCURGENTE,gas.FCVIATICO0
,sum(com.FNIMPORTE) FV_FNIMPORTE,sum(com.FNTOTAL) FV_FNTOTAL
--,(select NMCONCEPTO from PENDUPM.conceptogasto con where com.IDTPOGASTO = con.IDTPOGASTO and com.IDCONCEPTO = con.IDCONCEPTO) NMCONCEPTO
,con.NMCONCEPTO ,con.IDTPOGASTO
--,fa.FNIMPORTE GA_FNIMPORTECOMPROBA --,FA.IDGASTOMAIN ga_IDGASTOMAIN  --
--,FA.IDGASTOMAIN ga_IDGASTOMAIN
,BI.IMPORTESOLICITUD BI_IMPORTESOLICITUD ,BI.IMPORTEFACTURACION BI_IMPORTEFACTURACION
,fm.FCSTATUS ga_FCSTATUS
,xt."BatNbr" xt_BatNbr
FROM PENDUPM.GASTOMAIN Gas
inner join PENDUPM.comprobaciongasto com on gas.idgasto = com.idgasto
left join PENDUPM.conceptogasto con on com.IDTPOGASTO = con.IDTPOGASTO and com.IDCONCEPTO = con.IDCONCEPTO
left join (SELECT IDGASTOMAIN,IDCONCEPTO,DECODE (IDCONCEPTO,  1043, 8,  1045, 7,0)IDTPOGASTO,
        SUM (FNIMPORTE) FNIMPORTE,
        IDPLANVIAJE
   FROM pendupm.facturaasignacion fa
GROUP BY IDGASTOMAIN, IDCONCEPTO, IDPLANVIAJE) fa on  gas.idgasto =  fa.IDPLANVIAJE
                                               and com.IDTPOGASTO =  fa.IDTPOGASTO
left join (select solicitud, CONCEPTO1 ,
   sum (IMPORTESOLICITUD) IMPORTESOLICITUD ,
   sum(IMPORTEFACTURACION) IMPORTEFACTURACION
   from GASTOS_TMP_LAYOUT@pendubi.com BI
   group by solicitud, CONCEPTO1 ) bi on FA.IDCONCEPTO = bI.CONCEPTO1 AND FA.IDGASTOMAIN = BI.SOLICITUD                                      
--,GASTOS_TMP_LAYOUT@pendubi.com BI
left join PENDUPM.FACTURACIONMAIN fm on FA.IDGASTOMAIN = fm.IDGASTOMAIN
left join pendupm.xtravelfieldhdr xt on FA.IDGASTOMAIN = to_number(xt."ReqNbr")
where
-- and com.IDTPOGASTO = fa.IDCONCEPTO
--AND FA.IDCONCEPTO = bI.CONCEPTO1
--AND FA.IDGASTOMAIN = BI.SOLICITUD (+)
--and  
gas.FCSTATUS = 'F'
and com.IDTPOGASTO  in (7,8)  --7,8
and gas.FDFECREGISTRO >= to_Date ( '2017/01/01' ,'yyyy/MM/dd')
and com.idgasto =:pv  --4305039
group by 













select count(*) from (


--create  table pendupm.iaal as (
--3090  --2558 
select 
gas.IDGASTO ,gas.FDFECINI,gas.FDFECFIN,gas.FDFECREGISTRO,gas.IDSOLICITANTE,gas.FCSTATUS,gas.FNEMPNOMINA,gas.FCURGENTE,gas.FCVIATICO0
,sum(com.FNIMPORTE) FV_FNIMPORTE,sum(com.FNTOTAL) FV_FNTOTAL
,con.NMCONCEPTO ,con.IDTPOGASTO
,FA.IDGASTOMAIN ga_IDGASTOMAIN
,BI.IMPORTESOLICITUD BI_IMPORTESOLICITUD ,BI.IMPORTEFACTURACION BI_IMPORTEFACTURACION
,fm.FCSTATUS ga_FCSTATUS
,xt."BatNbr" xt_BatNbr ,xt."RefNbr" xt_RefNbr
,gl."CuryDrAmt" gl_CuryDrAmt
FROM 
/*4678*/    PENDUPM.GASTOMAIN Gas                            
/*2466*/    left join PENDUPM.comprobaciongasto com on gas.idgasto = com.idgasto 
/*2558*/    left join PENDUPM.conceptogasto con on com.IDTPOGASTO = con.IDTPOGASTO and com.IDCONCEPTO = con.IDCONCEPTO
/*2583*/    left join (SELECT IDGASTOMAIN,IDCONCEPTO,DECODE (IDCONCEPTO,  1043, 8,  1045, 7,0)IDTPOGASTO, SUM (FNIMPORTE) FNIMPORTE, IDPLANVIAJE FROM pendupm.facturaasignacion fa GROUP BY IDGASTOMAIN, IDCONCEPTO, IDPLANVIAJE) fa on  gas.idgasto =  fa.IDPLANVIAJE  and com.IDTPOGASTO =  fa.IDTPOGASTO 
/*2583*/    left join (select solicitud, CONCEPTO1 , sum (IMPORTESOLICITUD) IMPORTESOLICITUD , sum(IMPORTEFACTURACION) IMPORTEFACTURACION from GASTOS_TMP_LAYOUT@pendubi.com BI group by solicitud, CONCEPTO1 ) bi on FA.IDCONCEPTO = bI.CONCEPTO1 AND FA.IDGASTOMAIN = BI.SOLICITUD          
/*2583*/    left join PENDUPM.FACTURACIONMAIN fm on FA.IDGASTOMAIN = fm.IDGASTOMAIN 
/*2727*/    left join pendupm.xtravelfieldhdr xt on fm.IDGASTOMAIN = to_number(xt."ReqNbr") 
/*2727*/    left join (select sum(gl."CuryDrAmt") "CuryDrAmt" , "BatNbr" , "RefNbr"from pendupm.GLTRAN gl  where gl."Acct" like '60100%' group by "BatNbr" , "RefNbr") gl on  gl."BatNbr" = xt."BatNbr" and gl."RefNbr" = xt."RefNbr" 
where 
gas.FCSTATUS = 'F'
and gas.FDFECREGISTRO >= to_Date ( '2017/01/01' ,'yyyy/MM/dd')
and com.IDTPOGASTO  in (7,8)  --7,8
--and com.idgasto =:pv  --4305039  karla   4285053  12 
group by 
gas.IDGASTO ,gas.FDFECINI,gas.FDFECFIN,gas.FDFECREGISTRO,gas.IDSOLICITANTE,gas.FCSTATUS,gas.FNEMPNOMINA,gas.FCURGENTE,gas.FCVIATICO0--com.IDGASTO ,FA.IDGASTOMAIN,
,con.NMCONCEPTO ,con.IDTPOGASTO
,FA.IDGASTOMAIN
,BI.IMPORTESOLICITUD  ,BI.IMPORTEFACTURACION 
,fm.FCSTATUS
,xt."BatNbr",xt."RefNbr"
,gl."CuryDrAmt"

)
	  























































SELECT GM.IDGASTO AS ID_PLANVIAJE
, GM.FDFECREGISTRO
, GM.FNMONTOGASTO
, FA.IDGASTOMAIN AS 		
, FA.FNIMPORTECOMPROBA
, BI.SOLICITUD AS BI_IDGASTO
, BI.CONCEPTO BI_CONCEPTO
, BI.TOTALCOMP BI_MONTO  

FROM PENDUPM.GASTOMAIN GM  
LEFT JOIN PENDUPM.FACTURAASIGNACION FA ON FA.IDPLANVIAJE = GM.IDGASTO
LEFT JOIN PENDUDW.GASTOS_TMP_LAYOUT@pendubi.com BI ON BI.SOLICITUD = FA.IDGASTOMAIN   

WHERE TO_CHAR(GM.FDFECREGISTRO, 'yyyy/mm/dd') >= '2017/01/01' 
AND GM.FCSTATUS = 'F'
AND GM.FDFECINIRENTA IS NOT NULL



CREATE TABLE PENDUPM.TEMP_CONCILIACION
(
  ID_CONSOLIDACION  INTEGER,
  ID_PLANVIAJE      INTEGER,
  FDFECREGISTRO     DATE,
  MONTO_PV          FLOAT,
  ID_FACTURACION    INTEGER,
  MONTO_GASTO       FLOAT,
  BI_IDGASTO        INTEGER,
  BI_CONCEPTO       INTEGER,
  BI_MONTO          FLOAT
)
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
NOMONITORING;


ALTER TABLE PENDUPM.TEMP_CONCILIACION ADD (
  CONSTRAINT TEMP_CONCILIACION_PK
 PRIMARY KEY
 (ID_CONSOLIDACION));

 GRANT SELECT ON PENDUPM.TEMP_CONCILIACION TO COMERCIAL_OPER;

GRANT SELECT ON PENDUPM.TEMP_CONCILIACION TO ODI;

GRANT SELECT ON PENDUPM.TEMP_CONCILIACION TO OPERACION WITH GRANT OPTION;

GRANT DELETE, INSERT, SELECT, UPDATE ON PENDUPM.TEMP_CONCILIACION TO PM_OPER;

GRANT DELETE, INSERT, SELECT, UPDATE ON PENDUPM.TEMP_CONCILIACION TO TL_PM;







DROP SEQUENCE PENDUPM.SEQ_TEMP_CONCILIACION;

CREATE SEQUENCE PENDUPM.SEQ_TEMP_CONCILIACION
  START WITH 1
  MAXVALUE 999999999999999999
  MINVALUE 0
  NOCYCLE
  NOCACHE
  NOORDER;
  
GRANT SELECT ON PENDUPM.SEQ_TEMP_CONCILIACION TO COMERCIAL_OPER;

GRANT SELECT ON PENDUPM.SEQ_TEMP_CONCILIACION TO ODI;

GRANT SELECT ON PENDUPM.SEQ_TEMP_CONCILIACION TO OPERACION WITH GRANT OPTION;

GRANT  SELECT ON PENDUPM.SEQ_TEMP_CONCILIACION TO PM_OPER;

GRANT  SELECT ON PENDUPM.SEQ_TEMP_CONCILIACION TO TL_PM;


-- INSERT FINAL 

INSERT INTO PENDUPM.TEMP_CONCILIACION

SELECT PENDUPM.SEQ_TEMP_CONCILIACION.NEXTVAL, 
 GM.IDGASTO AS ID_PLANVIAJE
, TO_CHAR(GM.FDFECREGISTRO, 'dd/mm/yyyy') AS FDFECREGISTRO
, GM.FNMONTOGASTO
, FA.IDGASTOMAIN          
, FA.FNIMPORTECOMPROBA
, BI.SOLICITUD 
, BI.CONCEPTO 
, BI.TOTALCOMP  

FROM PENDUPM.GASTOMAIN GM  
LEFT JOIN PENDUPM.FACTURAASIGNACION FA ON FA.IDPLANVIAJE = GM.IDGASTO
LEFT JOIN PENDUDW.GASTOS_TMP_LAYOUT@pendubi.com BI ON BI.SOLICITUD = FA.IDGASTOMAIN   

WHERE TO_CHAR(GM.FDFECREGISTRO, 'yyyy/mm/dd') >= '2017/01/01' 
AND GM.FCSTATUS = 'F'
AND GM.FDFECINIRENTA IS NOT NULL;




SELECT  
      NVL(TRIM(A."Acct"),'0000000000') ID_CUENTA_CONTABLE 
      ,NVL(TRIM(A."CpnyID"),'000') ID_EMPRESA 
      ,NVL(TRIM(A."Module"),'00') ID_MODULO 
      ,NVL(TRIM(A."ProjectID"),'0000000000000000') ID_PROYECTO 
      ,NVL(TRIM(A."Id"),'0000000') ID_VENDEDOR 
      ,NVL(TRIM(A."Sub"),'000') ID_CENTRO_COSTO 
      ,NVL(TRIM(A."TranType"),'00') ID_TIPOTXN 
      ,NVL(CASE WHEN TRIM(A."BaseCuryID") = 'MXP' THEN 'MXN' ELSE TRIM(A."BaseCuryID") END,'MXN') ID_MONEDA 
      ,TRIM(A."BatNbr") ID_POLIZA 
      ,A."LineNbr" ID_LINEA 
      ,A."DrAmt" MNT_CARGO 
      ,A."CrAmt" MNT_ABONO 
      ,A."Posted" FL_POSTEO 
      ,A."PerEnt" PERIODO_ENT 
      ,case when to_number(A."PerPost")>((to_number(A."FiscYr")*100)+12) then ((to_number(A."FiscYr")*100)+12) else to_number(A."PerPost") end PERIODO_ASNTO 
      ,A."PerPost" PERIODO_ASNTOx 
      ,A."RefNbr" REFERENCIA 
      ,A."ExtRefNbr" Factura
      ,A."BatNbr" Lote 
      ,A."TranDesc" DESC_TNX 
      ,A."TranDate" FECHA_TNX 
      ,A."LUpd_DateTime" FECHA_ULTMODIF 
      ,A."tstamp" ID_SAK
      ,rtrim(B."SyberContract") AS NUMERO_CREDITO      
  FROM GLTRAN@ERPBASE.COM A,
       xAddDev@ERPBASE.COM B
  WHERE A."Posted" = 'P'  
    and A."BatNbr"=B."BatNbr"(+)
    AND A."RefNbr" = B."RefNbr"(+)
    and A."Module"=B."Module"(+)
    and A."User4" =B."LineNbr"(+)
    and TO_DATE(A."TranDate",'DD/MM/RRRR')>TO_DATE('31/12/2014','DD/MM/RRRR')
	
	
	
	---------------------------------------------------------------------------------------------------
	
	-- 10:24   9,362,547 registros
create table pendupm.GLTRAN as ( 
select *       
  FROM GLTRAN@ERPBASE.COM A
  )
  
  
  
  
-- 4:33   5,342,247  registros 
create table pendupm.xAddDev as ( 
select *    
  FROM xAddDev@ERPBASE.COM A
  ) 
  
  
  select count(*) from (


--create  table pendupm.iaal as (
--3090  --2558
select
gas.IDGASTO ,gas.FDFECINI,gas.FDFECFIN,gas.FDFECREGISTRO,gas.IDSOLICITANTE,gas.FCSTATUS,gas.FNEMPNOMINA,gas.FCURGENTE,gas.FCVIATICO0
,sum(com.FNIMPORTE) FV_FNIMPORTE,sum(com.FNTOTAL) FV_FNTOTAL
--,(select NMCONCEPTO from PENDUPM.conceptogasto con where com.IDTPOGASTO = con.IDTPOGASTO and com.IDCONCEPTO = con.IDCONCEPTO) NMCONCEPTO
,con.NMCONCEPTO ,con.IDTPOGASTO
--,fa.FNIMPORTE GA_FNIMPORTECOMPROBA --,FA.IDGASTOMAIN ga_IDGASTOMAIN  --
--,FA.IDGASTOMAIN ga_IDGASTOMAIN
,BI.IMPORTESOLICITUD BI_IMPORTESOLICITUD ,BI.IMPORTEFACTURACION BI_IMPORTEFACTURACION
,fm.FCSTATUS ga_FCSTATUS
,xt."BatNbr" xt_BatNbr
FROM PENDUPM.GASTOMAIN Gas
inner join PENDUPM.comprobaciongasto com on gas.idgasto = com.idgasto
left join PENDUPM.conceptogasto con on com.IDTPOGASTO = con.IDTPOGASTO and com.IDCONCEPTO = con.IDCONCEPTO
left join (SELECT IDGASTOMAIN,IDCONCEPTO,DECODE (IDCONCEPTO,  1043, 8,  1045, 7,0)IDTPOGASTO,
        SUM (FNIMPORTE) FNIMPORTE,
        IDPLANVIAJE
   FROM pendupm.facturaasignacion fa
GROUP BY IDGASTOMAIN, IDCONCEPTO, IDPLANVIAJE) fa on  gas.idgasto =  fa.IDPLANVIAJE
                                               and com.IDTPOGASTO =  fa.IDTPOGASTO
left join (select solicitud, CONCEPTO1 ,
   sum (IMPORTESOLICITUD) IMPORTESOLICITUD ,
   sum(IMPORTEFACTURACION) IMPORTEFACTURACION
   from GASTOS_TMP_LAYOUT@pendubi.com BI
   group by solicitud, CONCEPTO1 ) bi on FA.IDCONCEPTO = bI.CONCEPTO1 AND FA.IDGASTOMAIN = BI.SOLICITUD                                      
--,GASTOS_TMP_LAYOUT@pendubi.com BI
left join PENDUPM.FACTURACIONMAIN fm on FA.IDGASTOMAIN = fm.IDGASTOMAIN
left join pendupm.xtravelfieldhdr xt on FA.IDGASTOMAIN = to_number(xt."ReqNbr")
where
-- and com.IDTPOGASTO = fa.IDCONCEPTO
--AND FA.IDCONCEPTO = bI.CONCEPTO1
--AND FA.IDGASTOMAIN = BI.SOLICITUD (+)
--and  
gas.FCSTATUS = 'F'
and com.IDTPOGASTO  in (7,8)  --7,8
and gas.FDFECREGISTRO >= to_Date ( '2017/01/01' ,'yyyy/MM/dd')
and com.idgasto =:pv  --4305039
group by 



select count(*) from (


--create  table pendupm.iaal as (
--3090  --2558
select
gas.IDGASTO ,gas.FDFECINI,gas.FDFECFIN,gas.FDFECREGISTRO,gas.IDSOLICITANTE,gas.FCSTATUS,gas.FNEMPNOMINA,gas.FCURGENTE,gas.FCVIATICO0
,sum(com.FNIMPORTE) FV_FNIMPORTE,sum(com.FNTOTAL) FV_FNTOTAL
--,(select NMCONCEPTO from PENDUPM.conceptogasto con where com.IDTPOGASTO = con.IDTPOGASTO and com.IDCONCEPTO = con.IDCONCEPTO) NMCONCEPTO
,con.NMCONCEPTO ,con.IDTPOGASTO
--,fa.FNIMPORTE GA_FNIMPORTECOMPROBA --,FA.IDGASTOMAIN ga_IDGASTOMAIN  --
--,FA.IDGASTOMAIN ga_IDGASTOMAIN
,BI.IMPORTESOLICITUD BI_IMPORTESOLICITUD ,BI.IMPORTEFACTURACION BI_IMPORTEFACTURACION
,fm.FCSTATUS ga_FCSTATUS
,xt."BatNbr" xt_BatNbr ,xt."RefNbr" xt_RefNbr
,sum(gl."CuryDrAmt") gl_CuryDrAmt
FROM PENDUPM.GASTOMAIN Gas
inner join PENDUPM.comprobaciongasto com on gas.idgasto = com.idgasto
left join PENDUPM.conceptogasto con on com.IDTPOGASTO = con.IDTPOGASTO and com.IDCONCEPTO = con.IDCONCEPTO
left join (SELECT IDGASTOMAIN,IDCONCEPTO,DECODE (IDCONCEPTO,  1043, 8,  1045, 7,0)IDTPOGASTO,
        SUM (FNIMPORTE) FNIMPORTE,
        IDPLANVIAJE
   FROM pendupm.facturaasignacion fa
GROUP BY IDGASTOMAIN, IDCONCEPTO, IDPLANVIAJE) fa on  gas.idgasto =  fa.IDPLANVIAJE
                                               and com.IDTPOGASTO =  fa.IDTPOGASTO
left join (select solicitud, CONCEPTO1 ,
   sum (IMPORTESOLICITUD) IMPORTESOLICITUD ,
   sum(IMPORTEFACTURACION) IMPORTEFACTURACION
   from GASTOS_TMP_LAYOUT@pendubi.com BI
   group by solicitud, CONCEPTO1 ) bi on FA.IDCONCEPTO = bI.CONCEPTO1 AND FA.IDGASTOMAIN = BI.SOLICITUD                                      
--,GASTOS_TMP_LAYOUT@pendubi.com BI
left join PENDUPM.FACTURACIONMAIN fm on FA.IDGASTOMAIN = fm.IDGASTOMAIN
left join pendupm.xtravelfieldhdr xt on fm.IDGASTOMAIN = to_number(xt."ReqNbr")
left join pendupm.GLTRAN gl on  gl."BatNbr" = xt."BatNbr" and gl."RefNbr" = xt."RefNbr" and gl."Acct" like '60100%'
where
-- and com.IDTPOGASTO = fa.IDCONCEPTO
--AND FA.IDCONCEPTO = bI.CONCEPTO1
--AND FA.IDGASTOMAIN = BI.SOLICITUD (+)
--and  
gas.FCSTATUS = 'F'
and com.IDTPOGASTO  in (7,8)  --7,8




