CREATE OR REPLACE PACKAGE BODY PENDUPM.PCKGASTOLIB  IS
 
  /* HISTORIAL DE CAMBIOS
   * 20160901--> MAMV-->   Visualizacion de nombres para autorizadores de pagos doble en pantalla de autorizaciones
   * 20160902--> MAMV-->   Se agrega relacion para los conceptos en GETALARMAGASTOTIPO para los comentarios de gastos dobles
   * 20161003--> MAMV-->   Se agrega relacion para los conceptos en GETALARMAGASTOTIPO para los comentarios de etapas legales y getAlarmaGasto para autorizdosres de ETAPA02
   * JMM 20161005 - getAlarmaGasto. Se asegura que los valores de select no sean nulos. 
   * 20161129-->MAMV-->    Visualizacion de nombres para autorizadores y se agrega relacion por concepto a las autorizaciones para no marcar error de subconsulta.
   * 20170524-->MAMV-->    Se agrega validacion para cubo de gasto para visualizar los CENTROS de COSTOS para importes generales y carteras.
   * 20180828-->LJCUENCA--> se creo el proceso para insertar masivamente los comentarios y las respuestas de los diferentes tipos de autorizadores
   */
  

  PROCEDURE getAlarmaGasto (pnGasto          INTEGER,  /* numero de gasto */
                            pnUsuario        INTEGER,  /* Nuero de empleado */
                            salida        IN OUT T_CURSOR) IS

  TYPE T_CURSOR IS REF CURSOR;
  procesa            T_CURSOR;
  queCorreo       VARCHAR2(100) := '';
  queQuery        VARCHAR2(10000) := '';

  BEGIN

     BEGIN
       SELECT "email"
         INTO queCorreo
         from pendupm.vistaasociados
        WHERE "cvetra"  = pnUsuario;
     EXCEPTION WHEN OTHERS THEN
        queCorreo := '*ERROR*';
     END;

                DBMS_OUTPUT.PUT_LINE('*** ANTES CONDICIONES**'||queCorreo);

     OPEN procesa FOR
  SELECT IDALERTA, TIPODETALLE, NUMEROUSUARIOS,CVEUSUARIOS,NMALERTA,MAX(IDCONSEC) ES
    FROM (
       SELECT  IDTIPOAUTORIZA IDALERTA ,
               CASE WHEN IDTIPOAUTORIZA IN (6,7,8,45,46,64,65,66,67,68) THEN 'CREDITO'
                    WHEN IDTIPOAUTORIZA IN (9) THEN 'SINJUSTI'
                    WHEN IDTIPOAUTORIZA IN (10,34,44 ) THEN 'CONJUSTI'
                    WHEN IDTIPOAUTORIZA IN (41) THEN 'SOCTOSOP'
               END TIPODETALLE,
               CASE WHEN IDTIPOAUTORIZA IN (6) THEN (SELECT COUNT(1) FROM FACTURACIONAUT CC WHERE A.IDGASTOMAIN = CC.IDGASTOMAIN AND CC.IDTIPOAUTORIZA = 6)
                    WHEN IDTIPOAUTORIZA IN (7,8,45,46) THEN (SELECT COUNT(1) FROM FACTURACIONAUT CC WHERE A.IDGASTOMAIN = CC.IDGASTOMAIN AND CC.IDTIPOAUTORIZA IN (7,8,45,46))
                    WHEN IDTIPOAUTORIZA IN (9,64,65,68) THEN (SELECT COUNT(1) FROM FACTURACIONAUT CC WHERE A.IDGASTOMAIN = CC.IDGASTOMAIN AND CC.IDTIPOAUTORIZA IN(9,64,65,68))
                    WHEN IDTIPOAUTORIZA IN (10,34 ) THEN (SELECT COUNT(1) FROM FACTURACIONAUT CC WHERE A.IDGASTOMAIN = CC.IDGASTOMAIN AND CC.IDTIPOAUTORIZA IN (10,34 ))
                    WHEN IDTIPOAUTORIZA IN (44 ) THEN (SELECT COUNT(1) FROM FACTURACIONAUT CC WHERE A.IDGASTOMAIN = CC.IDGASTOMAIN AND CC.IDTIPOAUTORIZA = 44)
                    WHEN IDTIPOAUTORIZA IN (41 ) THEN (SELECT COUNT(1) FROM FACTURACIONAUT CC WHERE A.IDGASTOMAIN = CC.IDGASTOMAIN AND CC.IDTIPOAUTORIZA = 41)
               END NUMEROUSUARIOS,
               CASE WHEN IDTIPOAUTORIZA = 6 THEN (SELECT DISTINCT FCUSUUMBRAL03 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUUMBRAL03 IS NOT NULL)||'|'||
                                                    (SELECT DISTINCT FCUSUUMBRAL04 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUUMBRAL04 IS NOT NULL)||'|'||
                                                    (SELECT DISTINCT FCUSUUMBRAL05 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUUMBRAL05 IS NOT NULL)
                    WHEN IDTIPOAUTORIZA = 7 THEN (SELECT DISTINCT FCUSUETAPA01  FROM FACTURAASIGNACION Z WHERE Z.FCUSUETAPA01 IS NOT NULL AND A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUETAPA01 IS NOT NULL)||'|'||
                                                    (SELECT DISTINCT FCUSUETAPA02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUETAPA02 IS NOT NULL)
                    WHEN IDTIPOAUTORIZA = 8 THEN (SELECT DISTINCT FCUSUPGODBL01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUPGODBL01 IS NOT NULL)||'|'||
                                                    (SELECT DISTINCT FCUSUPGODBL02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUPGODBL02 IS NOT NULL)
                    WHEN IDTIPOAUTORIZA = 9 THEN (SELECT DISTINCT FCUSUJFEINMED  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUJFEINMED IS NOT NULL)
                    WHEN IDTIPOAUTORIZA = 10 THEN (SELECT DISTINCT FCUSUEMPRESA  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUEMPRESA IS NOT NULL)
                    WHEN IDTIPOAUTORIZA = 34 THEN (SELECT DISTINCT FCUSUURGENTE  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUURGENTE IS NOT NULL)
                    WHEN IDTIPOAUTORIZA = 41 THEN (SELECT DISTINCT FCUSUARIO01  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUARIO01 IS NOT NULL)||'|'||
                                                 (SELECT DISTINCT CASE WHEN FCUSUARIO02 = 0 THEN ''
                                                                       ELSE FCUSUARIO02||'|' END   FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUARIO02 IS NOT NULL)||
                                                 (SELECT DISTINCT CASE WHEN FCUSUARIO03 = 0 THEN ''
                                                                       ELSE FCUSUARIO03 END  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUARIO03 IS NOT NULL)
                    WHEN IDTIPOAUTORIZA = 44 THEN (SELECT DISTINCT FCUSUEXCGASTO01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUEXCGASTO01 IS NOT NULL)||'|'||
                                                    (SELECT DISTINCT FCUSUEXCGASTO02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUEXCGASTO02 IS NOT NULL)
                    WHEN IDTIPOAUTORIZA = 45 THEN (SELECT DISTINCT FCUSUETAFINAL01  FROM FACTURAASIGNACION Z WHERE Z.FCUSUETAFINAL01 IS NOT NULL AND A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUETAFINAL01 IS NOT NULL)||'|'||
                                                    (SELECT DISTINCT FCUSUETAFINAL02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUETAFINAL02 IS NOT NULL)
                    WHEN IDTIPOAUTORIZA = 46 THEN (SELECT DISTINCT FCUSULIQUIDADO01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCUSULIQUIDADO01 IS NOT NULL AND FCUSULIQUIDADO01 IS NOT NULL)||'|'||
                                                    (SELECT DISTINCT FCUSULIQUIDADO02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCUSULIQUIDADO02 IS NOT NULL AND FCUSULIQUIDADO02 IS NOT NULL)
                    WHEN IDTIPOAUTORIZA = 64 THEN (SELECT DISTINCT FCUSUNOFACT  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUNOFACT IS NOT NULL)
                    WHEN IDTIPOAUTORIZA = 65 THEN (SELECT DISTINCT FCUSUPM  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND FCUSUPM IS NOT NULL)
                    WHEN IDTIPOAUTORIZA = 66 THEN ( (SELECT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOAUTORIZA = 66 AND Z.FDFECAUTORIZA IS NULL ) )
                    WHEN IDTIPOAUTORIZA = 67 THEN ( (SELECT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOAUTORIZA = 67) )
                    WHEN IDTIPOAUTORIZA = 68 THEN ( (SELECT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOAUTORIZA = 68) )
               ELSE  'NO EXISTE'
               END CVEUSUARIOS,
               (SELECT NMDESCRIPCION
                  FROM CTCATALOGOGASTOS X
                 WHERE X.IDCATGASTO = A.IDTIPOAUTORIZA
               ) NMALERTA,
               IDCONSEC
          FROM FACTURACIONAUT  A
         WHERE IDGASTOMAIN = pnGasto AND FCAUTORIZADOR = queCorreo
           AND (IDGASTOMAIN,IDDELINDEX) = (SELECT IDGASTOMAIN, MAX(IDDELINDEX)
                                           FROM FACTURACIONAUT
                                           WHERE IDGASTOMAIN = pnGasto
                                          GROUP BY IDGASTOMAIN
                                        )
    )
    GROUP BY IDALERTA, TIPODETALLE, NUMEROUSUARIOS,CVEUSUARIOS,NMALERTA
       ORDER BY ES ;

     salida := procesa;

  EXCEPTION WHEN OTHERS THEN
     NULL;

  END getAlarmaGasto;


  PROCEDURE getAlarmaGastoTipo (pnGasto          INTEGER,  /* numero de gasto */
                                pnTipo           INTEGER,  /* Nuero de Alerta */
                                pnUsuario        INTEGER,  /* Nuero de empleado */
                                salida        IN OUT T_CURSOR) IS

  TYPE T_CURSOR IS REF CURSOR;
  procesa               T_CURSOR;
  psCondicion           VARCHAR2(1000) := '';
  pdEjecuta             VARCHAR2(32000) := '';

  BEGIN


    UPDATE FACTURAASIGNACION SET  FCRESULTJFEINMED = CASE WHEN FCRESULTJFEINMED IS NULL THEN  'Correcto' ELSE FCRESULTJFEINMED END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUJFEINMED = pnUsuario;

    UPDATE FACTURAASIGNACION SET  FCRESEMPRESA = CASE WHEN FCRESEMPRESA IS NULL THEN  'Correcto' ELSE FCRESEMPRESA END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUEMPRESA = pnUsuario;

     UPDATE FACTURAASIGNACION SET  FCRESURGENTE = CASE WHEN FCRESURGENTE IS NULL THEN  'Correcto' ELSE FCRESURGENTE END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUURGENTE = pnUsuario;

    UPDATE FACTURAASIGNACION SET  FCRESUMBRAL03 = CASE WHEN FCRESUMBRAL03 IS NULL THEN  'Correcto' ELSE FCRESUMBRAL03 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUUMBRAL03 = pnUsuario;
    UPDATE FACTURAASIGNACION SET  FCRESUMBRAL04 = CASE WHEN FCRESUMBRAL04 IS NULL THEN  'Correcto' ELSE FCRESUMBRAL04 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUUMBRAL04 = pnUsuario;
    UPDATE FACTURAASIGNACION SET  FCRESUMBRAL05 = CASE WHEN FCRESUMBRAL05 IS NULL THEN  'Correcto' ELSE FCRESUMBRAL05 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUUMBRAL05 = pnUsuario;

    UPDATE FACTURAASIGNACION SET  FCRESETAPA01 = CASE WHEN FCRESETAPA01 IS NULL THEN  'Correcto' ELSE FCRESETAPA01 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUETAPA01 = pnUsuario;
    UPDATE FACTURAASIGNACION SET  FCRESETAPA02 = CASE WHEN FCRESETAPA02 IS NULL THEN  'Correcto' ELSE FCRESETAPA02 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUETAPA02 = pnUsuario;

    UPDATE FACTURAASIGNACION SET  FCRESPGODBL01 = CASE WHEN FCRESPGODBL01 IS NULL THEN  'Correcto' ELSE FCRESPGODBL01 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUPGODBL01 = pnUsuario;
    UPDATE FACTURAASIGNACION SET  FCRESPGODBL02 = CASE WHEN FCRESPGODBL02 IS NULL THEN  'Correcto' ELSE FCRESPGODBL02 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUPGODBL02 = pnUsuario;

    UPDATE FACTURADCSOPORTE SET FCRESULTADO01 = CASE WHEN FCRESULTADO01 IS NULL THEN  'Correcto' ELSE FCRESULTADO01 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUARIO01 = pnUsuario;
    UPDATE FACTURADCSOPORTE SET FCRESULTADO02 = CASE WHEN FCRESULTADO02 IS NULL THEN  'Correcto' ELSE FCRESULTADO02 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUARIO02 = pnUsuario;
    UPDATE FACTURADCSOPORTE SET FCRESULTADO03 = CASE WHEN FCRESULTADO03 IS NULL THEN  'Correcto' ELSE FCRESULTADO03 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUARIO03 = pnUsuario;

    UPDATE FACTURAASIGNACION SET  FCRESEXCGASTO01 = CASE WHEN FCRESEXCGASTO01 IS NULL THEN  'Correcto' ELSE FCRESEXCGASTO01 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUEXCGASTO01 = pnUsuario;
    UPDATE FACTURAASIGNACION SET  FCRESEXCGASTO02 = CASE WHEN FCRESEXCGASTO02 IS NULL THEN  'Correcto' ELSE FCRESEXCGASTO02 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUEXCGASTO02 = pnUsuario;

    UPDATE FACTURAASIGNACION SET  FCRESEXCGASTO01 = CASE WHEN FCRESEXCGASTO01 IS NULL THEN  'Correcto' ELSE FCRESEXCGASTO01 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUEXCGASTO01 = pnUsuario;
    UPDATE FACTURAASIGNACION SET  FCRESEXCGASTO02 = CASE WHEN FCRESEXCGASTO02 IS NULL THEN  'Correcto' ELSE FCRESEXCGASTO02 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUEXCGASTO02 = pnUsuario;

    UPDATE FACTURAASIGNACION SET  FCRESETAFINAL01 = CASE WHEN FCRESETAFINAL01 IS NULL THEN  'Correcto' ELSE FCRESETAFINAL01 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUEXCGASTO01 = pnUsuario;
    UPDATE FACTURAASIGNACION SET  FCRESETAFINAL02 = CASE WHEN FCRESETAFINAL02 IS NULL THEN  'Correcto' ELSE FCRESETAFINAL02 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUEXCGASTO02 = pnUsuario;

    UPDATE FACTURAASIGNACION SET  FCRESLIQ01 = CASE WHEN FCRESLIQ01 IS NULL THEN  'Correcto' ELSE FCRESLIQ01 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUEXCGASTO01 = pnUsuario;
    UPDATE FACTURAASIGNACION SET  FCRESLIQ02 = CASE WHEN FCRESLIQ02 IS NULL THEN  'Correcto' ELSE FCRESLIQ02 END
     WHERE IDGASTOMAIN = pnGasto AND FCUSUEXCGASTO02 = pnUsuario;

    COMMIT;


       SELECT   CASE WHEN pnTipo = 6 THEN ' AND FCQUEUMBRAL > 0 '
                    WHEN pnTipo = 7 THEN 'AND (VERETAPACDACHKNO IS NOT NULL OR VERETAPAABIERTANO IS NOT NULL OR FCCODACCEXTNO IS NOT NULL OR FCCODRESEXTNO IS NOT NULL)'
                    WHEN pnTipo = 8 THEN 'AND FNPAGODOBLE > 0 '
                    WHEN pnTipo= 9 THEN ' AND FCUSUJFEINMED IS NOT NULL '
                    WHEN pnTipo = 10 THEN ''
                    WHEN pnTipo = 34 THEN ''
                    WHEN pnTipo = 41 THEN ''
                    WHEN pnTipo = 44 THEN ''
                    WHEN pnTipo = 45 THEN ''
                    WHEN pnTipo = 46 THEN ' AND (FCCREDSTATUS IS NOT NULL OR FCCREDCOLA IS NOT NULL) '
                    WHEN pnTipo = 64 THEN ' AND FCUSUNOFACT IS NOT NULL '
                    WHEN pnTipo = 65 THEN ' AND FCUSUPM IS NOT NULL '
                    WHEN pnTipo = 66 THEN ''
                    WHEN pnTipo = 67 THEN ''
                    WHEN pnTipo = 68 THEN ''
               ELSE  'NO EXISTE'
               END CONDICION
         INTO psCondicion
        FROM DUAL;



--       IF (pnTipo = 6 or pnTipo = 7 or pnTipo = 8 or pnTipo = 45 or pnTipo = 46) THEN

             pdEjecuta := 'SELECT ''--> ''||(SELECT NMDESCRIP  FROM CTCUENTACATEGORIA C
                         WHERE C.IDCUENTACAT = (SELECT IDCATEGORIA FROM CTCATALOGOCUENTAS H WHERE A.IDCONCEPTO = H.IDCONCEPTO))||''<BR/>''||
                    ''--> ''||(SELECT NMDESCRIP  FROM CTCUENTACATEGORIA C
                    WHERE C.IDCUENTACAT = (SELECT IDSUBCATEGORIA FROM CTCATALOGOCUENTAS H WHERE A.IDCONCEPTO = H.IDCONCEPTO)) CATEGSUBCAT,
                    (SELECT NMCONCEPTO FROM CTCATALOGOCUENTAS B WHERE B.IDCONCEPTO = A.IDCONCEPTO) CONCEPTO, IDCONCEPTO, FCCREDITOCARTERA,
                     CASE WHEN '||pnTipo||' = 6 THEN PCKCONVENIOS.formatComas(FNIMPORTE)
                          WHEN '||pnTipo||' = 66 THEN ''Fecha ejecucion:<br /><b>''||TO_CHAR(FECHA_EJECUCION,''DD-MM-YYYY'')||''</b><br />menor a fecha solicitud:<br /><b>''||TO_CHAR(A.FDFECREGISTRO,''DD-MM-YYYY'')||''</b>''
                          WHEN '||pnTipo||' = 67 THEN ''El proveedor: <br /><b>''||(SELECT NMPROVEEDOR FROM PENDUPM.CTPROVEEDORGASTO PG WHERE PG.IDPROVEEDORGTO IN (SELECT FM.IDPROVEEDORGTO FROM PENDUPM.FACTURACIONMAIN FM WHERE FM.IDGASTOMAIN = '||pnGasto||'))||''</b> <br />no pertenece a la cuenta: <br /><b>''||A.FCCREDITOCARTERA||''</b>''
                          WHEN '||pnTipo||' = 68 THEN ''No. Tarea:<br /><b>''||A.NOTAREA||''</b><br>Categoria: <br /><b>''||(SELECT DESCRIPCION  FROM PENDUCRM.CAT_CLASIFICA_TAREA WHERE STATUS  = 1 AND TIPO = ''AB'' AND  ID IN (SELECT CLASIFICA_TAREA  FROM PENDUCRM.TAREA TAR WHERE  ID = A.NOTAREA))||''</b> <br />Estado: <br /><b>''||(SELECT DESC_EDO_TAREA FROM PENDUCRM.CAT_ESTADO_TAREA WHERE ID IN (SELECT ID_ESTADO FROM PENDUCRM.TAREA TAR WHERE  ID = A.NOTAREA))||''</b>''
                            WHEN '||pnTipo||' = 8 THEN TO_CHAR(FNPAGODOBLE)
                                                    WHEN '||pnTipo||' = 45 THEN  ''ETAPA CRR/VER: ''||VERETAPAFIN
                                                    WHEN '||pnTipo||'= 46 THEN  CASE WHEN FCCREDSTATUS IS NOT NULL THEN ''STATUS: ''||FCCREDSTATUS  END||'' ''||
                                                                               CASE WHEN FCCREDCOLA IS NOT NULL THEN ''COLA: ''||FCCREDCOLA END
                            WHEN '||pnTipo||' = 7 THEN CASE WHEN VERETAPACDACHK IS NOT NULL THEN ''ETAPA CRR/VER: ''||VERETAPACDACHK END||'' ''||
                                                                       CASE WHEN VERETAPAABIERTA IS NOT NULL THEN ''ETAPA ABR: ''||VERETAPAABIERTA END||'' ''||
                                                                       CASE WHEN FCCODACCEXT IS NOT NULL THEN ''CA: ''||FCCODACCEXT END||'' ''||
                                                                       CASE WHEN FCCODRESEXT IS NOT NULL THEN ''CR: ''||FCCODRESEXT END
                          else ''''
                     END ALERTA,
                    FCDETALLECREDITO,
                       CASE WHEN '||pnTipo||' = 6 THEN (SELECT DISTINCT TRIM(fcjustificacionumbral) FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificacionumbral IS NOT NULL AND A.FDFECREGISTRO = Z.FDFECREGISTRO)
                            WHEN '||pnTipo||' = 7 THEN (SELECT DISTINCT TRIM(fcjustificaetapa)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificaetapa IS NOT NULL AND A.FDFECREGISTRO = Z.FDFECREGISTRO)
                            WHEN '||pnTipo||' = 8 THEN (SELECT DISTINCT TRIM(fcjustificapagodbl)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificapagodbl IS NOT NULL AND A.FDFECREGISTRO = Z.FDFECREGISTRO)
                            WHEN '||pnTipo||' = 9 THEN ''''
                            WHEN '||pnTipo||' = 10 THEN (SELECT DISTINCT TRIM(fcjustificaempresa)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificaempresa IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 34 THEN (SELECT DISTINCT TRIM(fcjustificaurgente)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificaurgente IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 41 THEN (SELECT DISTINCT FCUSUARIO FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCUSUARIO IS NOT NULL)
                            WHEN '||pnTipo||' = 44 THEN (SELECT DISTINCT TRIM(fcjustificaexcgasto)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificaexcgasto IS NOT NULL)
                            WHEN '||pnTipo||' = 45 THEN (SELECT DISTINCT TRIM(fcjustificetafinal)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificetafinal IS NOT NULL)
                            WHEN '||pnTipo||' = 46 THEN (SELECT DISTINCT TRIM(fcjustificaliq)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificaliq IS NOT NULL)
                            WHEN '||pnTipo||' = 64 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOALARMA = 65 AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 65 THEN ''''
                            WHEN '||pnTipo||' = 66 THEN (SELECT DISTINCT ALERTAFECHAEJECCOMENTARIO  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.ALERTAFECHAEJECCOMENTARIO IS NOT NULL )
                            WHEN '||pnTipo||' = 67 THEN (SELECT DISTINCT ALERTASIGNACOMENTARIO  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.ALERTASIGNACOMENTARIO IS NOT NULL )
                            WHEN '||pnTipo||' = 68 THEN (SELECT DISTINCT FCJUSTIFIACIONTAREA  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCJUSTIFIACIONTAREA IS NOT NULL )
                       ELSE  ''NO EXISTE''
                       END JUSTIFICACION,
                       CASE WHEN '||pnTipo||' = 6 THEN (SELECT DISTINCT fcresumbral03 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresumbral03 IS NOT NULL AND A.FDFECREGISTRO = Z.FDFECREGISTRO)||''|''||
                                                            (SELECT DISTINCT fcresumbral04 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresumbral04 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT fcresumbral05 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresumbral05 IS NOT NULL)
                            WHEN '||pnTipo||' = 7 THEN (SELECT DISTINCT fcresetapa01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresetapa01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT fcresetapa02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresetapa02 IS NOT NULL)
                            WHEN '||pnTipo||' = 8 THEN (SELECT DISTINCT FCRESPGODBL01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCRESPGODBL01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCRESPGODBL02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCRESPGODBL02 IS NOT NULL)
                            WHEN '||pnTipo||' = 9 THEN (SELECT DISTINCT fcresultjfeinmed  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresultjfeinmed IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 10 THEN (SELECT DISTINCT fcresempresa  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresempresa IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 34 THEN (SELECT DISTINCT fcresurgente  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.fcresurgente IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 41 THEN (SELECT DISTINCT FCRESULTADO01  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCCREDITO = A.FCCREDITOCARTERA AND Z.FCRESULTADO01 IS NOT NULL)||''|''||
                                                         (SELECT DISTINCT CASE WHEN FCUSUARIO02 = 0 THEN ''''
                                                                                ELSE FCRESULTADO02 END  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND Z.FCCREDITO = A.FCCREDITOCARTERA)||''|''||
                                                         (SELECT DISTINCT CASE WHEN FCUSUARIO03 = 0 THEN ''''
                                                                                ELSE FCRESULTADO03 END  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND Z.FCCREDITO = A.FCCREDITOCARTERA)
                            WHEN '||pnTipo||' = 44 THEN (SELECT DISTINCT fcresexcgasto01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresexcgasto01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT fcresexcgasto02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresexcgasto02 IS NOT NULL)
                            WHEN '||pnTipo||' = 45 THEN (SELECT DISTINCT fcresetafinal01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresetafinal01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT fcresetafinal02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresetafinal02 IS NOT NULL)
                            WHEN '||pnTipo||' = 46 THEN (SELECT DISTINCT fcresliq01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresliq01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT fcresliq02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresliq02 IS NOT NULL)
                            WHEN '||pnTipo||' = 64 THEN (SELECT DISTINCT FCRESULTNOFACT  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCRESULTNOFACT IS NOT NULL AND Z.FCESREEMBOLSABLE =''N'' AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 65 THEN (SELECT DISTINCT FCRESULTPM  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCRESULTPM IS NOT NULL AND Z.FCESREEMBOLSABLE =''N'' AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 66 THEN ''Correcto''
                            WHEN '||pnTipo||' = 67 THEN ''Correcto''
                            WHEN '||pnTipo||' = 68 THEN ''Correcto''
                       ELSE  ''NO EXISTE''
                       END RESULTADOS,
                       CASE WHEN '||pnTipo||' = 6 THEN (SELECT DISTINCT FCCOMENTARIO FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUUMBRAL03 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCCOMENTARIO FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUUMBRAL04 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCCOMENTARIO FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUUMBRAL05 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)
                            WHEN '||pnTipo||' = 7 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUETAPA01 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUETAPA02 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)
                            WHEN '||pnTipo||' = 8 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUPGODBL01 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUPGODBL02 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)
                            WHEN '||pnTipo||' = 9 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUJFEINMED AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 10 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUEMPRESA AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1 )
                            WHEN '||pnTipo||' = 34 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUURGENTE AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 41 THEN (SELECT DISTINCT FCCOMENTARIO01  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND Z.FCCREDITO = A.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO01 IS NOT NULL)||''|''||
                                                 (SELECT DISTINCT CASE WHEN FCUSUARIO02 = 0 THEN ''''
                                                                       ELSE FCCOMENTARIO02||''|'' END   FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND Z.FCCREDITO = A.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND IDTIPOMOVTO ='||pnTipo||')||
                                                 (SELECT DISTINCT CASE WHEN FCUSUARIO03 = 0 THEN ''''
                                                                       ELSE FCCOMENTARIO03 END  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND Z.FCCREDITO = A.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND IDTIPOMOVTO ='||pnTipo||')
                            WHEN '||pnTipo||' = 44 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUEXCGASTO01 AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSUEXCGASTO02 AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)
                            WHEN '||pnTipo||' = 45 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSUETAFINAL02 AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSUETAFINAL02 AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)
                            WHEN '||pnTipo||' = 46 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSULIQUIDADO01 AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSULIQUIDADO02 AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)
                            WHEN '||pnTipo||' = 64 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSUNOFACT AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 65 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSUPM AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 66 THEN ''''
                            WHEN '||pnTipo||' = 67 THEN ''OK''
                            WHEN '||pnTipo||' = 68 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1)
                       ELSE  ''NO EXISTE''
                       END COMENTARIOS,
                       CASE WHEN '||pnTipo||' = 6 THEN (SELECT DISTINCT FCUSUUMBRAL03 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL03 IS NOT NULL)||''|''||
                                                (SELECT DISTINCT FCUSUUMBRAL04 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL04 IS NOT NULL)||''|''||
                                                (SELECT DISTINCT FCUSUUMBRAL05 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL05 IS NOT NULL)
                            WHEN '||pnTipo||' = 7 THEN (SELECT DISTINCT FCUSUETAPA01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAPA01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCUSUETAPA02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAPA02 IS NOT NULL)
                            WHEN '||pnTipo||' = 8 THEN (SELECT DISTINCT FCUSUPGODBL01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPGODBL01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCUSUPGODBL02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPGODBL02 IS NOT NULL)
                            WHEN '||pnTipo||' = 9 THEN (SELECT DISTINCT FCUSUJFEINMED  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUJFEINMED IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 10 THEN (SELECT DISTINCT FCUSUEMPRESA  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEMPRESA IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 34 THEN (SELECT DISTINCT FCUSUURGENTE  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUURGENTE IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 41 THEN (SELECT DISTINCT FCUSUARIO01  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCCREDITO = A.FCCREDITOCARTERA AND Z.FCUSUARIO01 IS NOT NULL)||''|''||
                                                 (SELECT DISTINCT CASE WHEN FCUSUARIO02 = 0 THEN ''''
                                                                       ELSE FCUSUARIO02||''|'' END   FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCCREDITO = A.FCCREDITOCARTERA )||
                                                 (SELECT DISTINCT CASE WHEN FCUSUARIO03 = 0 THEN ''''
                                                                       ELSE FCUSUARIO03 END  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND Z.FCCREDITO = A.FCCREDITOCARTERA)
                            WHEN '||pnTipo||' = 44 THEN (SELECT DISTINCT FCUSUEXCGASTO01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEXCGASTO01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCUSUEXCGASTO02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEXCGASTO02 IS NOT NULL)
                            WHEN '||pnTipo||' = 45 THEN (SELECT DISTINCT FCUSUETAFINAL01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUETAFINAL01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCUSUETAFINAL02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAFINAL02 IS NOT NULL)
                            WHEN '||pnTipo||' = 46 THEN (SELECT DISTINCT FCUSULIQUIDADO01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSULIQUIDADO01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCUSULIQUIDADO02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSULIQUIDADO02 IS NOT NULL)
                            WHEN '||pnTipo||' = 64 THEN (SELECT DISTINCT FCUSUNOFACT  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUNOFACT IS NOT NULL AND Z.FCESREEMBOLSABLE =''N'' AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 65 THEN (SELECT DISTINCT FCUSUPM  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPM IS NOT NULL AND Z.FCESREEMBOLSABLE =''N'' AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 66 THEN (SELECT DISTINCT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND IDTIPOAUTORIZA = 66 AND Z.FDFECAUTORIZA IS NULL )
                            WHEN '||pnTipo||' = 67 THEN (SELECT DISTINCT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND IDTIPOAUTORIZA = 67 )
                            WHEN '||pnTipo||' = 68 THEN (SELECT DISTINCT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND IDTIPOAUTORIZA = 68 )
                       ELSE  ''NO EXISTE''
                       END USUARIOS,TO_CHAR(FDFECREGISTRO, ''DDMMYYYYHH24MISS'') FECHAREGISTRO
                    FROM FACTURAASIGNACION A WHERE IDGASTOMAIN = '||pnGasto||' AND
                      INSTR( CASE WHEN '||pnTipo||' = 6 THEN (SELECT DISTINCT FCUSUUMBRAL03 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL03 IS NOT NULL)||''|''||
                                                (SELECT DISTINCT FCUSUUMBRAL04 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL04 IS NOT NULL)||''|''||
                                                (SELECT DISTINCT FCUSUUMBRAL05 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL05 IS NOT NULL)
                            WHEN '||pnTipo||' = 7 THEN (SELECT DISTINCT FCUSUETAPA01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAPA01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCUSUETAPA02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAPA02 IS NOT NULL)
                            WHEN '||pnTipo||' = 8 THEN (SELECT DISTINCT FCUSUPGODBL01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPGODBL01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCUSUPGODBL02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPGODBL02 IS NOT NULL)
                            WHEN '||pnTipo||' = 9 THEN (SELECT DISTINCT FCUSUJFEINMED  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUJFEINMED IS NOT NULL  AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 10 THEN (SELECT DISTINCT FCUSUEMPRESA  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEMPRESA IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 34 THEN (SELECT DISTINCT FCUSUURGENTE  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUURGENTE IS NOT NULL AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 41 THEN (SELECT DISTINCT FCUSUARIO  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCUSUARIO IS NOT NULL)||''|''||
                                                         (SELECT DISTINCT FCUSUARIO01  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCUSUARIO01 IS NOT NULL)||''|''||
                                                         (SELECT DISTINCT CASE WHEN FCUSUARIO02 = 0 THEN ''''
                                                                                ELSE FCUSUARIO02 END  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN )
                            WHEN '||pnTipo||' = 44 THEN (SELECT DISTINCT FCUSUEXCGASTO01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEXCGASTO01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCUSUEXCGASTO02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEXCGASTO02 IS NOT NULL)
                            WHEN '||pnTipo||' = 45 THEN (SELECT DISTINCT FCUSUETAFINAL01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUETAFINAL01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCUSUETAFINAL02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAFINAL02 IS NOT NULL)
                            WHEN '||pnTipo||' = 46 THEN (SELECT DISTINCT FCUSULIQUIDADO01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSULIQUIDADO01 IS NOT NULL)||''|''||
                                                            (SELECT DISTINCT FCUSULIQUIDADO02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSULIQUIDADO02 IS NOT NULL)
                            WHEN '||pnTipo||' = 64 THEN (SELECT DISTINCT FCUSUNOFACT  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUNOFACT IS NOT NULL AND Z.FCESREEMBOLSABLE =''N''  AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 65 THEN (SELECT DISTINCT FCUSUPM  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPM IS NOT NULL  AND Z.FCESREEMBOLSABLE =''N'' AND ROWNUM = 1)
                            WHEN '||pnTipo||' = 66 THEN (SELECT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOAUTORIZA = 66 AND Z.FDFECAUTORIZA IS NULL )
                            WHEN '||pnTipo||' = 67 THEN (SELECT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOAUTORIZA = 67)
                            WHEN '||pnTipo||' = 68 THEN (SELECT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOAUTORIZA = 68)
                       ELSE  ''NO EXISTE''
                       END , '||''''||pnUsuario||''''||') > 0 '||psCondicion;


       dbms_output.put_line('....'||pdEjecuta);

       OPEN procesa FOR pdEjecuta;
       salida := procesa;



  EXCEPTION WHEN OTHERS THEN

   dbms_output.put_line('***ERROR***'||sqlerrm);
   NULL;

  END getAlarmaGastoTipo;


  FUNCTION queUsuarioEs (psNumEmpleado INTEGER) RETURN VARCHAR2  IS
      quienEs  VARCHAR2(150) := '';
  BEGIN
      SELECT "nombreCompleto" NOMBRE
        INTO quienEs
        from pendupm.vistaasociados
       WHERE "cvetra" = psNumEmpleado;

      RETURN quienEs;
  EXCEPTION
      WHEN OTHERS
      THEN
         RETURN '-1';
  END queUsuarioEs;


  PROCEDURE setAutorizaResultado ( pnGasto          INTEGER,  /* numero de gasto */
                                   pnTipo           INTEGER,  /* Nuero de Alerta */
                                   pcCredito        VARCHAR2, /* NUMERO DECREDITO */
                                   pnConcepto       INTEGER,  /* numero de concepto */
                                   pnUsuario        INTEGER,  /* Nuero de empleado */
                                   psValor          VARCHAR2, /* Valor del Resultado */
                                   psFechaRegistro  VARCHAR2, /* Fecha Registro */
                                   psError   OUT    VARCHAR2)   IS

  errOra   VARCHAR2(1000) := '';

  BEGIN
     psError := '0';

     IF ( pnTipo != 41) THEN

        UPDATE FACTURAASIGNACION SET FCRESUMBRAL03  = CASE WHEN pnTipo = 6 THEN CASE WHEN FCUSUUMBRAL03 = pnUsuario THEN psValor ELSE FCRESUMBRAL03 END ELSE FCRESUMBRAL03 END,
                                     FCRESUMBRAL04  = CASE WHEN pnTipo = 6 THEN CASE WHEN FCUSUUMBRAL04 = pnUsuario THEN psValor ELSE FCRESUMBRAL04 END ELSE FCRESUMBRAL04 END,
                                     FCRESUMBRAL05  = CASE WHEN pnTipo = 6 THEN CASE WHEN FCUSUUMBRAL05 = pnUsuario THEN psValor ELSE FCRESUMBRAL05 END ELSE FCRESUMBRAL05 END,
                                     FCRESETAPA01   = CASE WHEN pnTipo = 7 THEN CASE WHEN FCUSUETAPA01 = pnUsuario THEN psValor ELSE FCRESETAPA01 END ELSE FCRESETAPA01 END,
                                     FCRESETAPA02   = CASE WHEN pnTipo = 7 THEN CASE WHEN FCUSUETAPA02 = pnUsuario THEN psValor ELSE FCRESETAPA02 END ELSE FCRESETAPA02 END,
                                     FCRESPGODBL01  = CASE WHEN pnTipo = 8 THEN CASE WHEN FCUSUPGODBL01 = pnUsuario THEN psValor ELSE FCRESPGODBL01 END ELSE FCRESPGODBL01 END,
                                     FCRESPGODBL02  = CASE WHEN pnTipo = 8 THEN CASE WHEN FCUSUPGODBL02 = pnUsuario THEN psValor ELSE FCRESPGODBL02 END ELSE FCRESPGODBL02 END,
                                     FCRESULTJFEINMED = CASE WHEN pnTipo = 9 THEN CASE WHEN FCUSUJFEINMED = pnUsuario THEN psValor ELSE FCRESULTJFEINMED END ELSE FCRESULTJFEINMED END,
                                     FCRESEMPRESA   = CASE WHEN pnTipo = 10 THEN CASE WHEN FCUSUEMPRESA = pnUsuario THEN psValor ELSE FCRESEMPRESA END ELSE FCRESEMPRESA END,
                                     FCRESURGENTE   = CASE WHEN pnTipo = 34 THEN CASE WHEN FCUSUURGENTE = pnUsuario THEN psValor ELSE FCRESURGENTE END ELSE FCRESURGENTE END,
                                     FCRESEXCGASTO01  = CASE WHEN pnTipo = 44 THEN CASE WHEN FCUSUEXCGASTO01 = pnUsuario THEN psValor ELSE FCRESEXCGASTO01 END ELSE FCRESEXCGASTO01 END,
                                     FCRESEXCGASTO02  = CASE WHEN pnTipo = 44 THEN CASE WHEN FCUSUEXCGASTO02 = pnUsuario THEN psValor ELSE FCRESEXCGASTO02 END ELSE FCRESEXCGASTO02 END,
                                     FCRESETAFINAL01  = CASE WHEN pnTipo = 45 THEN CASE WHEN FCUSUETAFINAL01 = pnUsuario THEN psValor ELSE FCRESETAFINAL01 END ELSE FCRESETAFINAL01 END,
                                     FCRESETAFINAL02  = CASE WHEN pnTipo = 45 THEN CASE WHEN FCUSUETAFINAL02 = pnUsuario THEN psValor ELSE FCRESETAFINAL02 END ELSE FCRESETAFINAL02 END,
                                     FCRESLIQ01     = CASE WHEN pnTipo = 46 THEN CASE WHEN FCUSULIQUIDADO01 = pnUsuario THEN psValor ELSE FCRESLIQ01 END ELSE FCRESLIQ01 END,
                                     FCRESLIQ02     = CASE WHEN pnTipo = 46 THEN CASE WHEN FCUSULIQUIDADO02 = pnUsuario THEN psValor ELSE FCRESLIQ02 END ELSE FCRESLIQ02 END,
                                     FCRESULTNOFACT = CASE WHEN pnTipo = 64 AND FCESREEMBOLSABLE = 'N' THEN CASE WHEN FCUSUNOFACT = pnUsuario THEN psValor ELSE FCRESULTNOFACT END ELSE FCRESULTNOFACT END,
                                     FCRESULTPM = CASE WHEN pnTipo = 65 AND FCESREEMBOLSABLE = 'N' THEN CASE WHEN FCUSUPM = pnUsuario THEN psValor ELSE FCRESULTPM END ELSE FCRESULTPM END
          WHERE IDGASTOMAIN = pnGasto AND IDCONCEPTO = pnConcepto AND FCCREDITOCARTERA  = pcCredito AND TO_CHAR(FDFECREGISTRO, 'DDMMYYYYHH24MISS') = psFechaRegistro;
     ELSE
         UPDATE FACTURADCSOPORTE SET FCRESULTADO01 = CASE WHEN pnTipo = 41 THEN CASE WHEN FCUSUARIO = pnUsuario THEN psValor ELSE FCRESULTADO01 END ELSE FCRESULTADO01 END,
                                     FCRESULTADO02 = CASE WHEN pnTipo = 41 THEN CASE WHEN FCUSUARIO01 = pnUsuario THEN psValor ELSE FCRESULTADO02 END ELSE FCRESULTADO02 END,
                                     FCRESULTADO03 = CASE WHEN pnTipo = 41 THEN CASE WHEN FCUSUARIO02 = pnUsuario THEN psValor ELSE FCRESULTADO03 END ELSE FCRESULTADO03 END,
                                     FDFECREGISTRO01 = CASE WHEN pnTipo = 41 THEN CASE WHEN FCUSUARIO = pnUsuario THEN SYSDATE ELSE FDFECREGISTRO01 END ELSE FDFECREGISTRO01 END,
                                     FDFECREGISTRO02 = CASE WHEN pnTipo = 41 THEN CASE WHEN FCUSUARIO01 = pnUsuario THEN SYSDATE ELSE FDFECREGISTRO02 END ELSE FDFECREGISTRO02 END,
                                     FDFECREGISTRO03 = CASE WHEN pnTipo = 41 THEN CASE WHEN FCUSUARIO02 = pnUsuario THEN SYSDATE ELSE FDFECREGISTRO03 END ELSE FDFECREGISTRO03 END
          WHERE IDGASTOMAIN = pnGasto AND IDCONCEPTO = pnConcepto AND FCCREDITO  = pcCredito;

     END IF;

       COMMIT;

  EXCEPTION WHEN OTHERS THEN
    ROLLBACK;
    errOra := SQLERRM;
    psError := '*ERROR* '||errOra;
  END setAutorizaResultado;


  PROCEDURE setAutorizaComentario ( pnGasto          INTEGER,  /* numero de gasto */
                                   pnTipo           INTEGER,  /* Nuero de Alerta */
                                   pcCredito        VARCHAR2, /* NUMERO DECREDITO */
                                   pnConcepto       INTEGER,  /* numero de concepto */
                                   pnUsuario        INTEGER,  /* Nuero de empleado */
                                   psValor          VARCHAR2, /* Valor del comentario */
                                   psFechaRegistro  VARCHAR2, /* Fecha Registro */
                                   psError   OUT    VARCHAR2)   IS
   existe     INTEGER  := 0;
   queMovto    INTEGER  := 0;
   errOra   VARCHAR2(1000) := '';
  BEGIN
     psError := '0';

     IF ( pnTipo != 41) THEN

         SELECT COUNT(1) INTO existe FROM ASIGNACIONCOMENTA
          WHERE IDGASTOMAIN = pnGasto AND IDCONCEPTO = pnConcepto AND FCCREDITOCARTERA  = pcCredito
            AND IDTIPOALARMA = pnTipo AND IDUSUARIO = pnUsuario;

         SELECT IDTIPOMOVTO INTO queMovto FROM FACTURAASIGNACION WHERE IDGASTOMAIN = pnGasto AND IDCONCEPTO = pnConcepto AND FCCREDITOCARTERA  = pcCredito AND TO_CHAR(FDFECREGISTRO, 'DDMMYYYYHH24MISS') = psFechaRegistro;

         IF ( existe = 0) THEN
            INSERT INTO ASIGNACIONCOMENTA VALUES ( pnGasto,pnConcepto, queMovto,pcCredito,pnTipo,pnUsuario,psValor,SYSDATE);

         ELSE
            UPDATE ASIGNACIONCOMENTA SET FCCOMENTARIO = psValor,
                                         FDFECREGISTRO = SYSDATE
              WHERE IDGASTOMAIN = pnGasto AND IDCONCEPTO = pnConcepto AND FCCREDITOCARTERA  = pcCredito
                AND IDTIPOALARMA = pnTipo AND IDUSUARIO = pnUsuario;

         END IF;

     ELSE

     dbms_output.put_line(' es docto soporte ....'||psError);

         UPDATE FACTURADCSOPORTE SET FCCOMENTARIO01 = CASE WHEN pnTipo = 41 THEN CASE WHEN FCUSUARIO01 = pnUsuario THEN psValor ELSE FCCOMENTARIO01 END ELSE FCCOMENTARIO01 END,
                                     FCCOMENTARIO02 = CASE WHEN pnTipo = 41 THEN CASE WHEN FCUSUARIO02 = pnUsuario THEN psValor ELSE FCCOMENTARIO02 END ELSE FCCOMENTARIO02 END,
                                     FCCOMENTARIO03 = CASE WHEN pnTipo = 41 THEN CASE WHEN FCUSUARIO03 = pnUsuario THEN psValor ELSE FCCOMENTARIO03 END ELSE FCCOMENTARIO03 END,
                                     FDFECREGISTRO01 = CASE WHEN pnTipo = 41 THEN CASE WHEN FCUSUARIO01 = pnUsuario THEN SYSDATE ELSE FDFECREGISTRO01 END ELSE FDFECREGISTRO01 END,
                                     FDFECREGISTRO02 = CASE WHEN pnTipo = 41 THEN CASE WHEN FCUSUARIO02 = pnUsuario THEN SYSDATE ELSE FDFECREGISTRO02 END ELSE FDFECREGISTRO02 END,
                                     FDFECREGISTRO03 = CASE WHEN pnTipo = 41 THEN CASE WHEN FCUSUARIO03 = pnUsuario THEN SYSDATE ELSE FDFECREGISTRO03 END ELSE FDFECREGISTRO03 END
          WHERE IDGASTOMAIN = pnGasto AND IDCONCEPTO = pnConcepto AND FCCREDITO  = pcCredito;

     END IF;

       COMMIT;

  EXCEPTION WHEN OTHERS THEN
    ROLLBACK;
    errOra := SQLERRM;
    psError := '*ERROR* '||errOra;

  END setAutorizaComentario;


 PROCEDURE getCreaPdfAvaluo (salida        IN OUT T_CURSOR) IS

  TYPE T_CURSOR IS REF CURSOR;
  procesa            T_CURSOR;


  BEGIN


     OPEN procesa FOR
        SELECT   A.IDGASTOMAIN GASTO,
           FCCREDITO,
           NVL (U1CARTERA, U2CARTERA) CARTERA,
            VA."nombreCompleto" SOLICITANTE,
           NVL (
              (SELECT   CASE
                           WHEN ZZ.FCRESULTADO = 'Autorizado'
                           THEN
                              PENDUPM.PCKENVIOCORREO.APLFECHA (
                                 ZZ.FDFECAUTORIZA
                              )
                           ELSE
                              ''
                        END
                 FROM   PENDUPM.FACTURACIONAUT ZZ
                WHERE   ZZ.IDGASTOMAIN = A.IDGASTOMAIN
                        AND FCAUTORIZADOR =
                              (SELECT   "email"
                                 from   pendupm.vistaasociados
                                WHERE   "cvetra" = A.FCUSUARIO01)
                        AND (ZZ.IDGASTOMAIN, IDCONSEC) IN
                                 (  SELECT   IDGASTOMAIN, MAX (IDCONSEC)
                                      FROM   PENDUPM.FACTURACIONAUT
                                     WHERE   FCAUTORIZADOR =
                                                (SELECT   "email"
                                                   from   pendupm.vistaasociados
                                                  WHERE   "cvetra" =
                                                             A.FCUSUARIO01)
                                  GROUP BY   IDGASTOMAIN)),
              '*'
           )
              VERIF01,
           NVL (
              (SELECT   CASE
                           WHEN ZZ.FCRESULTADO = 'Autorizado'
                           THEN
                              PENDUPM.PCKENVIOCORREO.APLFECHA (
                                 ZZ.FDFECAUTORIZA
                              )
                           ELSE
                              ''
                        END
                 FROM   PENDUPM.FACTURACIONAUT ZZ
                WHERE   ZZ.IDGASTOMAIN = A.IDGASTOMAIN
                        AND FCAUTORIZADOR =
                              (SELECT   "email"
                                 from   pendupm.vistaasociados
                                WHERE   "cvetra" = A.FCUSUARIO02)
                        AND (ZZ.IDGASTOMAIN, IDCONSEC) IN
                                 (  SELECT   IDGASTOMAIN, MAX (IDCONSEC)
                                      FROM   PENDUPM.FACTURACIONAUT
                                     WHERE   FCAUTORIZADOR =
                                                (SELECT   "email"
                                                   from   pendupm.vistaasociados
                                                  WHERE   "cvetra" =
                                                             A.FCUSUARIO02)
                                  GROUP BY   IDGASTOMAIN)),
              '*'
           )
              VERIF02,
           NVL (
              (SELECT   CASE
                           WHEN ZZ.FCRESULTADO = 'Autorizado'
                           THEN
                              PENDUPM.PCKENVIOCORREO.APLFECHA (
                                 ZZ.FDFECAUTORIZA
                              )
                           ELSE
                              ''
                        END
                 FROM   PENDUPM.FACTURACIONAUT ZZ
                WHERE   ZZ.IDGASTOMAIN = A.IDGASTOMAIN
                        AND FCAUTORIZADOR =
                              (SELECT   "email"
                                 from   pendupm.vistaasociados
                                WHERE   "cvetra" = A.FCUSUARIO03)
                        AND (ZZ.IDGASTOMAIN, IDCONSEC) IN
                                 (  SELECT   IDGASTOMAIN, MAX (IDCONSEC)
                                      FROM   PENDUPM.FACTURACIONAUT
                                     WHERE   FCAUTORIZADOR =
                                                (SELECT   "email"
                                                   from   pendupm.vistaasociados
                                                  WHERE   "cvetra" =
                                                             A.FCUSUARIO03)
                                  GROUP BY   IDGASTOMAIN)),
              '*'
           )
              VERIF03,
              'pdftk '
           || '/opt/processmaker/shared/sites/workflow/files/gastos/soportelw/'
           || A.IDGASTOMAIN
           || '_'
           || A.FCCREDITO
           || '.pdf  '
           || REPLACE (
                 A.FCRUTAFILE,
                 'http://quantum1.pendulum.com.mx/sysworkflow/es/classic/cases/cases_ShowGastos?archivo=',
                 '/opt/processmaker/shared/sites/workflow/files/gastos/documentos/'
              )
           || ' cat output /opt/processmaker/shared/sites/workflow/files/gastos/comiteavaluos/'
           || A.IDGASTOMAIN
           || '_'
           || A.FCCREDITO
           || '_'
           || A.IDCONSEC
           || '_1.pdf' EJECUTA
            FROM   PENDUPM.FACTURADCSOPORTE A
            JOIN (SELECT DISTINCT FNNUMEMPLEADO, IDGASTOMAIN FROM PENDUPM.FACTURACIONMAIN) PASO ON (PASO.IDGASTOMAIN = A.IDGASTOMAIN)
            join pendupm.vistaasociadoscompleta va on (va."cvetra" =  paso.fnnumempleado)
            LEFT JOIN RCVRY.UDA1 UD1 ON (A.FCCREDITO = U1ACCT)
            LEFT JOIN  RCVRY.UDA2 UD2 ON (A.FCCREDITO = U2ACCT)
           WHERE   A.IDGASTOMAIN IN
                         (SELECT   IDGASTOMAIN
                            FROM   PENDUPM.FACTURACIONBITACORA
                           WHERE   FCUSUARIO = 'kmoure@pendulum.com.mx'
                                   AND FCRESULTADO = 'Autorizado')
                   AND FCRESULTADO03 = 'Correcto'
                   AND (A.IDGASTOMAIN, IDCONCEPTO, IDCONSEC) NOT IN
                            (SELECT   IDGASTOMAIN, IDCONCEPTO, IDCONSEC
                               FROM   PENDUPM.GASTOSOPORTELW)
        ORDER BY   A.IDGASTOMAIN, A.FCCREDITO;

     /*
            SELECT   IDGASTOMAIN GASTO,FCCREDITO,
                     (SELECT   NVL (U1CARTERA, U2CARTERA) FROM RCVRY.DELQMST DM LEFT JOIN RCVRY.UDA1 UD1 ON (DM.DMACCT = U1ACCT) LEFT JOIN RCVRY.UDA2 UD2 ON (DM.DMACCT = U2ACCT) WHERE   DM.DMACCT = FCCREDITO) CARTERA,
                     (select   "nombrecompleto" from   pendupm.vistaasociadoscompleta where  "cvetra" = (select   distinct fnnumempleado from   facturacionmain paso where   paso.idgastomain = a.idgastomain)) solicitante,
                     nvl ((select   case when zz.fcresultado = 'autorizado' then pckenviocorreo.aplfecha (zz.fdfecautoriza) else ''  end from   facturacionaut zz where   zz.idgastomain = a.idgastomain and fcautorizador = (select   "email" from   pendupm.vistaasociados where   "cvetra" = a.fcusuario01) and ( zz.idgastomain,idconsec) in (select idgastomain ,max(idconsec) from facturacionaut where fcautorizador = (select "email" from pendupm.vistaasociados where  "cvetra" = a.fcusuario01) group by idgastomain )),'*')   verif01,
                     nvl ((select   case when zz.fcresultado = 'autorizado' then pckenviocorreo.aplfecha (zz.fdfecautoriza) else ''  end from   facturacionaut zz where   zz.idgastomain = a.idgastomain and fcautorizador = (select   "email" from   pendupm.vistaasociados where   "cvetra" = a.fcusuario02) and ( zz.idgastomain,idconsec) in (select idgastomain ,max(idconsec) from facturacionaut where fcautorizador = (select "email" from pendupm.vistaasociados where  "cvetra" = a.fcusuario02) group by idgastomain )),'*')   verif02,
                     nvl ((select   case when zz.fcresultado = 'autorizado' then pckenviocorreo.aplfecha (zz.fdfecautoriza) else ''  end from   facturacionaut zz where   zz.idgastomain = a.idgastomain and fcautorizador = (select   "email" from   pendupm.vistaasociados where   "cvetra" = a.fcusuario03) and ( zz.idgastomain,idconsec) in (select idgastomain ,max(idconsec) from facturacionaut where fcautorizador = (select "email" from pendupm.vistaasociados where  "cvetra" = a.fcusuario03) group by idgastomain )),'*')   verif03,
                     'pdftk '||
                    '/opt/processmaker/shared/sites/workflow/files/gastos/soportelw/'||IDGASTOMAIN||'_'||FCCREDITO||'.pdf  '||
                    REPLACE(FCRUTAFILE, 'http://quantum1.pendulum.com.mx/sysworkflow/es/classic/cases/cases_ShowGastos?archivo=','/opt/processmaker/shared/sites/workflow/files/gastos/documentos/')||
                    ' cat output /opt/processmaker/shared/sites/workflow/files/gastos/comiteavaluos/'||IDGASTOMAIN||'_'||FCCREDITO||'_'||IDCONSEC||'_1.pdf'  EJECUTA
              FROM FACTURADCSOPORTE A
             WHERE IDGASTOMAIN IN (
                SELECT IDGASTOMAIN FROM FACTURACIONBITACORA
            WHERE FCUSUARIO = 'kmoure@pendulum.com.mx'
            AND FCRESULTADO = 'Autorizado')
            AND FCRESULTADO03 = 'Correcto'
            AND ( IDGASTOMAIN, IDCONCEPTO,IDCONSEC) NOT IN (SELECT IDGASTOMAIN, IDCONCEPTO,IDCONSEC
                                                              FROM GASTOSOPORTELW
                                                          )
       AND ROWNUM <= 50
       ORDER BY IDGASTOMAIN, FCCREDITO;
      CUANDO SON MUCHOS REGISTROS SE REALIZA DE 100 EN 100
     SELECT
        IDENT,
        IDGASTOMAIN GASTO,FCCREDITO,
                             (SELECT   NVL (U1CARTERA, U2CARTERA) FROM RCVRY.DELQMST DM LEFT JOIN RCVRY.UDA1 UD1 ON (DM.DMACCT = U1ACCT) LEFT JOIN RCVRY.UDA2 UD2 ON (DM.DMACCT = U2ACCT) WHERE   DM.DMACCT = FCCREDITO) CARTERA,
                             (select   "nombrecompleto" from   pendupm.vistaasociados where  "cvetra" = (select   distinct fnnumempleado from   facturacionmain paso where   paso.idgastomain = avaluos.idgastomain)) solicitante,
                             nvl ((select   case when zz.fcresultado = 'autorizado' then pckenviocorreo.aplfecha (zz.fdfecautoriza) else ''  end from   facturacionaut zz where   zz.idgastomain = avaluos.idgastomain and fcautorizador = (select   "email" from   pendupm.vistaasociados where   "cvetra" = avaluos.fcusuario01) and ( zz.idgastomain,idconsec) in (select idgastomain ,max(idconsec) from facturacionaut where fcautorizador = (select "email" from pendupm.vistaasociados where  "cvetra" = avaluos.fcusuario01) group by idgastomain )),'*')   verif01,
                             nvl ((select   case when zz.fcresultado = 'autorizado' then pckenviocorreo.aplfecha (zz.fdfecautoriza) else ''  end from   facturacionaut zz where   zz.idgastomain = avaluos.idgastomain and fcautorizador = (select   "email" from   pendupm.vistaasociados where   "cvetra" = avaluos.fcusuario02) and ( zz.idgastomain,idconsec) in (select idgastomain ,max(idconsec) from facturacionaut where fcautorizador = (select "email" from pendupm.vistaasociados where  "cvetra" = avaluos.fcusuario02) group by idgastomain )),'*')   verif02,
                             nvl ((select   case when zz.fcresultado = 'autorizado' then pckenviocorreo.aplfecha (zz.fdfecautoriza) else ''  end from   facturacionaut zz where   zz.idgastomain = avaluos.idgastomain and fcautorizador = (select   "email" from   pendupm.vistaasociados where   "cvetra" = avaluos.fcusuario03) and ( zz.idgastomain,idconsec) in (select idgastomain ,max(idconsec) from facturacionaut where fcautorizador = (select "email" from pendupm.vistaasociados where  "cvetra" = avaluos.fcusuario03) group by idgastomain )),'*')   verif03,
                             'pdftk '||
                            '/opt/processmaker/shared/sites/workflow/files/gastos/soportelw/'||IDGASTOMAIN||'_'||FCCREDITO||'.pdf  '||
                            REPLACE(FCRUTAFILE, 'http://quantum1.pendulum.com.mx/sysworkflow/es/classic/cases/cases_ShowGastos?archivo=','/opt/processmaker/shared/sites/workflow/files/gastos/documentos/')||
                            ' cat output /opt/processmaker/shared/sites/workflow/files/gastos/comiteavaluos/'||IDGASTOMAIN||'_'||FCCREDITO||'_'||IDCONSEC||'_1.pdf'  EJECUTA
        FROM (SELECT * FROM (SELECT ROWNUM IDENT, A.* FROM FACTURADCSOPORTE A
        WHERE IDGASTOMAIN IN (
                        SELECT IDGASTOMAIN FROM FACTURACIONBITACORA
                    WHERE FCUSUARIO = 'kmoure@pendulum.com.mx'
                    AND FCRESULTADO = 'Autorizado')
                    AND FCRESULTADO03 = 'Correcto'
                    AND ( IDGASTOMAIN, IDCONCEPTO,IDCONSEC) NOT IN (SELECT IDGASTOMAIN, IDCONCEPTO,IDCONSEC
                                                                      FROM GASTOSOPORTELW
                    )
        ORDER BY ROWNUM, IDGASTOMAIN, FCCREDITO) PASO
        WHERE PASO.IDENT BETWEEN 1401 AND 1500) AVALUOS;*/
     salida := procesa;

  EXCEPTION WHEN OTHERS THEN
     NULL;

  END getCreaPdfAvaluo;

 PROCEDURE getExcelCuboGasto (salida        IN OUT T_CURSOR) IS

  TYPE T_CURSOR IS REF CURSOR;
  procesa            T_CURSOR;

  BEGIN

     OPEN procesa FOR
         SELECT *
          FROM (
                    SELECT IDGASTOMAIN                  SOLICITUD,
                           IDCONCEPTO                   CONCEPTO,
                           IDTIPOMOVTO                  TIPOVALOR,
                           FCCREDITOCARTERA             CREDITO_CARTERA,
                           (SELECT NVL(U1CARTERA, U2CARTERA)
                              FROM RCVRY.DELQMST DM LEFT JOIN RCVRY.UDA1 UD1 ON (DM.DMACCT = UD1.U1ACCT) LEFT JOIN RCVRY.UDA2 UD2 ON (DM.DMACCT = UD2.U2ACCT)
                             WHERE DMACCT = A.FCCREDITOCARTERA
                           ) CARTERA,
                           (CASE WHEN (SELECT NVL(DMBRANCH,'SIN CC') FROM RCVRY.DELQMST DM WHERE DMACCT = A.FCCREDITOCARTERA) = '' THEN
                                  (SELECT NVL(DMBRANCH,'SIN CC') FROM RCVRY.DELQMST DM WHERE DMACCT = A.FCCREDITOCARTERA)
                                 WHEN IDTIPOMOVTO IN (2,3) THEN
                                  (SELECT NMCENTROCOSTO FROM PENDUPM.CENTROCOSTOGASTO where IDCATEGORIA = 3 AND FCSTATUS = 'A' AND NMCENTROCOSTO = A.FCCENTROCOSTOS)
                                 WHEN IDTIPOMOVTO IN (42,4) THEN
                                  (SELECT NMCENTROCOSTO  FROM PENDUPM.CENTROCOSTOGASTO where IDCATEGORIA IN (1,2,5,6,7,8,9) AND FCSTATUS = 'A' AND IDCENTROCOSTO = A.FCCENTROCOSTOS)
                                 ELSE
                                  'NA'
                            END
                           ) CENTROCOSTOS,
                           FNIMPORTE                    IMPORTESOLICITUD,
                           FNIMPORTECOMPROBA            IMPORTEFACTURACION,
                           FDFECCOMPROBA                FECHAASIGNACION,
                           FCESFACTURABLE               ESFACTURABLE,
                           FCDYNAMICS                   CVEDYNAMICS,
                           FCUSUJFEINMED                USUJFEINMED,
                           FCRESULTJFEINMED             AUT_JFEINMED,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 9 AND B.FCUSUARIOAUTORIZA = FCUSUJFEINMED
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 9 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_JFEINMED,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 9 AND B.FCUSUARIOAUTORIZA = FCUSUJFEINMED
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 9 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_JFEINMED,
                           FCQUEUMBRAL                  UMBRALALERTA,
                           FNUMBRAL                     IMPORTEUMBRAL,
                           FNUMBRALREBASADO             UMBRALEXCEDENTE,
                           CONVERT(FCJUSTIFICACIONUMBRAL, 'WE8MSWIN1252','UTF8')        JUSTIFICA_UMBRAL,
                           FCUSUUMBRAL03                USUARIOUMBRAL1,
                           FCRESUMBRAL03                AUT_UMBRAL01,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 6 AND B.FCUSUARIOAUTORIZA = FCUSUUMBRAL03
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 6 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_UMBRAL1,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 6 AND B.FCUSUARIOAUTORIZA = FCUSUUMBRAL03
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 6 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_UMBRAL1,
                           FCUSUUMBRAL04                USUARIOUMBRAL2,
                           FCRESUMBRAL04                AUT_UMBRAL02,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 6 AND B.FCUSUARIOAUTORIZA = FCUSUUMBRAL04
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 6 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_UMBRAL2,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 6 AND B.FCUSUARIOAUTORIZA = FCUSUUMBRAL04
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 6 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_UMBRAL2,
                           FCUSUUMBRAL05                USUARIOUMBRAL3,
                           FCRESUMBRAL05                AUT_UMBRAL03,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 6 AND B.FCUSUARIOAUTORIZA = FCUSUUMBRAL05
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 6 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_UMBRAL3,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 6 AND B.FCUSUARIOAUTORIZA = FCUSUUMBRAL05
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 6 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_UMBRAL3,
                           FNPAGODOBLE                  NUMPGODBL,
                           CONVERT(FCJUSTIFICAPAGODBL, 'WE8MSWIN1252','UTF8')           JUSTIFICAPGODBL,
                           FCUSUPGODBL01                USUPGODBL1,
                           FCRESPGODBL01                AUTPGODBL1,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA =8 AND B.FCUSUARIOAUTORIZA = FCUSUPGODBL01
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 8 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_PGODBL1,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 8 AND B.FCUSUARIOAUTORIZA = FCUSUPGODBL01
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 8 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_PGODBL1,
                           FCUSUPGODBL02                USUPGODBL2,
                           FCRESPGODBL02                AUTPGODBL2,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 8 AND B.FCUSUARIOAUTORIZA = FCUSUPGODBL02
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 8 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_PGODBL2,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 8 AND B.FCUSUARIOAUTORIZA = FCUSUPGODBL02
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 8 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_PGODBL2 ,
                           CONVERT(FCJUSTIFICAETAPA, 'WE8MSWIN1252','UTF8')             JUSTIFICAETAPA,
                           CONVERT(FCJUSTIFICACODIGOS, 'WE8MSWIN1252','UTF8')           JUSTIFICACODACC,
                           FCUSUETAPA01                 USUETAPA1,
                           FCRESETAPA01                 AUTETAPA1,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 7 AND B.FCUSUARIOAUTORIZA = FCUSUETAPA01
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 7 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_ETAPA1,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 7 AND B.FCUSUARIOAUTORIZA = FCUSUETAPA01
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA =7 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_ETAPA1,
                           FCUSUETAPA02                 USUETAPA2,
                           FCRESETAPA02                 AUTETAPA2 ,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 7 AND B.FCUSUARIOAUTORIZA = FCUSUETAPA02
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 7 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_ETAPA2,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 7 AND B.FCUSUARIOAUTORIZA = FCUSUETAPA02
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 7 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_ETAPA2 ,
                           FCUSUEMPRESA                 USUEMPRESA,
                           CONVERT(FCJUSTIFICAEMPRESA, 'WE8MSWIN1252','UTF8')           JUSTIFICAEMPRESA,
                           FCRESEMPRESA                 AUTEMPRESA,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 10 AND B.FCUSUARIOAUTORIZA = FCUSUEMPRESA
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 10 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_EMPRESA,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 10 AND B.FCUSUARIOAUTORIZA = FCUSUEMPRESA
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 10 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_EMPRESA,
                           FCUSUURGENTE                 USUURGENTE,
                           CONVERT(FCJUSTIFICAURGENTE, 'WE8MSWIN1252','UTF8')           JUSTIFICAURGENTE,
                           FCRESURGENTE                 AUTURGENTE,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 34 AND B.FCUSUARIOAUTORIZA = FCUSUURGENTE
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 10 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_URGENTE,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 34 AND B.FCUSUARIOAUTORIZA = FCUSUURGENTE
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 34 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_URGENTE,
                           CONVERT(FCJUSTIFICALIQ, 'WE8MSWIN1252','UTF8')               JUSTIFICASTSTCOLA,
                           FCUSULIQUIDADO01             USUSTSTCOLA1,
                           FCRESLIQ01                   AUTSTSTCOLA1,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 46 AND B.FCUSUARIOAUTORIZA = FCUSULIQUIDADO01
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 46 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_STSTCOLA1,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 46 AND B.FCUSUARIOAUTORIZA = FCUSULIQUIDADO01
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 46 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_STSTCOLA1,
                           FCUSULIQUIDADO02             USUSTSTCOLA2,
                           FCRESLIQ02                   AUTSTSTCOLA2,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 46 AND B.FCUSUARIOAUTORIZA = FCUSULIQUIDADO02
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 46 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_STSTCOLA2,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 46 AND B.FCUSUARIOAUTORIZA = FCUSULIQUIDADO02
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 46 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_STSTCOLA2,
                           CONVERT(FCJUSTIFICETAFINAL, 'WE8MSWIN1252','UTF8')           JUSTIFICAETAPAFIN,
                           FCUSUETAFINAL01              USUETAPAFIN1,
                           FCRESETAFINAL01              AUTETAPAFIN1,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 45 AND B.FCUSUARIOAUTORIZA = FCUSUETAFINAL01
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 45 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_ETAPAFIN1,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 45 AND B.FCUSUARIOAUTORIZA = FCUSUETAFINAL01
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 45 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_ETAPAFIN1,
                           FCUSUETAFINAL02              USUETAPAFIN2,
                           FCRESETAFINAL02              AUTETAPAFIN2,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 45 AND B.FCUSUARIOAUTORIZA = FCUSUETAFINAL02
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 45 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_ETAPAFIN2,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 45 AND B.FCUSUARIOAUTORIZA = FCUSUETAFINAL02
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 45 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_ETAPAFIN2,
                           CONVERT(FCJUSTIFICAEXCGASTO, 'WE8MSWIN1252','UTF8')       JUSTIFICAEXCGASTO,
                           FCUSUEXCGASTO01           USUEXCGASTO1,
                           FCRESEXCGASTO01           AUTEXCGASTO1,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 44 AND B.FCUSUARIOAUTORIZA = FCUSUEXCGASTO01
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 44 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_EXCGASTO1,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 44 AND B.FCUSUARIOAUTORIZA = FCUSUEXCGASTO01
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 44 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_EXCGASTO1,
                           FCUSUEXCGASTO02           USUEXCGASTO2,
                           FCRESEXCGASTO02           AUTEXCGASTO2,
                           (SELECT MAX(FDFECAUTORIZA)  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 44 AND B.FCUSUARIOAUTORIZA = FCUSUEXCGASTO02
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 44 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) FECAUT_EXCGASTO2,
                           (SELECT DISTINCT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURACIONAUT B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND IDTIPOAUTORIZA = 44 AND B.FCUSUARIOAUTORIZA = FCUSUETAFINAL02
                               AND (B.IDGASTOMAIN,B.FCUSUARIOAUTORIZA,IDDELINDEX) in (SELECT IDGASTOMAIN, FCUSUARIOAUTORIZA, MAX(IDDELINDEX) FROM FACTURACIONAUT H
                                                                  WHERE  IDTIPOAUTORIZA = 44 GROUP BY IDGASTOMAIN, FCUSUARIOAUTORIZA
                                                                )
                           ) COMAUT_EXCGASTO2,
                           (SELECT FCUSUARIO01  FROM FACTURADCSOPORTE B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                           ) USUAUTSOP1,
                           (SELECT FDFECREGISTRO01  FROM FACTURADCSOPORTE B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                           ) FECAUT_AUTSOP1,
                           (SELECT FCRESULTADO01  FROM FACTURADCSOPORTE B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                           ) RESAUT_AUTSOP1,
                           (SELECT CONVERT(FCCOMENTARIO01, 'WE8MSWIN1252','UTF8')  FROM FACTURADCSOPORTE B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                           ) COMAUT_AUTSOP1,
                           (SELECT FCUSUARIO02  FROM FACTURADCSOPORTE B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                           ) USUAUTSOP2,
                           (SELECT FDFECREGISTRO02  FROM FACTURADCSOPORTE B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                           ) FECAUT_AUTSOP2,
                           (SELECT FCRESULTADO02  FROM FACTURADCSOPORTE B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                           ) RESAUT_AUTSOP2,
                           (SELECT CONVERT(FCCOMENTARIO02, 'WE8MSWIN1252','UTF8')  FROM FACTURADCSOPORTE B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                           ) COMAUT_AUTSOP2,
                           (SELECT FCUSUARIO03  FROM FACTURADCSOPORTE B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                           ) USUAUTSOP3,
                           (SELECT FDFECREGISTRO03  FROM FACTURADCSOPORTE B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                           ) FECAUT_AUTSOP3,
                           (SELECT FCRESULTADO03  FROM FACTURADCSOPORTE B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                           ) RESAUT_AUTSOP3,
                           (SELECT CONVERT(FCCOMENTARIO03, 'WE8MSWIN1252','UTF8')  FROM FACTURADCSOPORTE B
                             WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                           ) COMAUT_AUTSOP3,
                         (SELECT REPLACE(FCNOMBRE, '[R]','')
                                  FROM FACTURADCSOPORTE B
                                 WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                                   AND  (B.IDGASTOMAIN,B.IDCONCEPTO,B.FCCREDITO,REPLACE(FCNOMBRE, '[R]',''),1) IN
                                   (SELECT IDGASTOMAIN, IDCONCEPTO, FCCREDITO,REPLACE(FCNOMBRE, '[R]','') NOMBRE, ROW_NUMBER()
                                           OVER (PARTITION BY IDGASTOMAIN,FCCREDITO ORDER BY IDCONSEC) AS CUALES
                                           FROM FACTURADCSOPORTE
                                   )
                               ) DOCTOSOP_NM1,
                               (SELECT REPLACE(FCRUTAFILE, 'http://quantum1.pendulum.com.mx/sysworkflow/es/classic/cases/cases_ShowGastos?archivo=','http://doc.pendulum.com.mx/PM/gastos/documentos/')
                                  FROM FACTURADCSOPORTE B
                                 WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                                   AND  (B.IDGASTOMAIN,B.IDCONCEPTO,B.FCCREDITO,REPLACE(FCNOMBRE, '[R]',''),1) IN
                                   (SELECT IDGASTOMAIN, IDCONCEPTO, FCCREDITO,REPLACE(FCNOMBRE, '[R]','') NOMBRE, ROW_NUMBER()
                                           OVER (PARTITION BY IDGASTOMAIN,FCCREDITO ORDER BY IDCONSEC) AS CUALES
                                           FROM FACTURADCSOPORTE
                                   )
                               )  DOCTOSOP_LINK1 ,
                               (SELECT REPLACE(FCNOMBRE, '[R]','')
                                  FROM FACTURADCSOPORTE B
                                 WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                                   AND  (B.IDGASTOMAIN,B.IDCONCEPTO,B.FCCREDITO,REPLACE(FCNOMBRE, '[R]',''),2) IN
                                   (SELECT IDGASTOMAIN, IDCONCEPTO, FCCREDITO,REPLACE(FCNOMBRE, '[R]','') NOMBRE, ROW_NUMBER()
                                           OVER (PARTITION BY IDGASTOMAIN,FCCREDITO ORDER BY IDCONSEC) AS CUALES
                                           FROM FACTURADCSOPORTE
                                   )
                               ) DOCTOSOP_NM2,
                               (SELECT REPLACE(FCRUTAFILE, 'http://quantum1.pendulum.com.mx/sysworkflow/es/classic/cases/cases_ShowGastos?archivo=','http://doc.pendulum.com.mx/PM/gastos/documentos/')
                                  FROM FACTURADCSOPORTE B
                                 WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                                   AND  (B.IDGASTOMAIN,B.IDCONCEPTO,B.FCCREDITO,REPLACE(FCNOMBRE, '[R]',''),2) IN
                                   (SELECT IDGASTOMAIN, IDCONCEPTO, FCCREDITO,REPLACE(FCNOMBRE, '[R]','') NOMBRE, ROW_NUMBER()
                                           OVER (PARTITION BY IDGASTOMAIN,FCCREDITO ORDER BY IDCONSEC) AS CUALES
                                           FROM FACTURADCSOPORTE
                                   )
                               )  DOCTOSOP_LINK2,
                               (SELECT REPLACE(FCNOMBRE, '[R]','')
                                  FROM FACTURADCSOPORTE B
                                 WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                                   AND  (B.IDGASTOMAIN,B.IDCONCEPTO,B.FCCREDITO,REPLACE(FCNOMBRE, '[R]',''),3) IN
                                   (SELECT IDGASTOMAIN, IDCONCEPTO, FCCREDITO,REPLACE(FCNOMBRE, '[R]','') NOMBRE, ROW_NUMBER()
                                           OVER (PARTITION BY IDGASTOMAIN,FCCREDITO ORDER BY IDCONSEC) AS CUALES
                                           FROM FACTURADCSOPORTE
                                   )
                               ) DOCTOSOP_NM3,
                               (SELECT REPLACE(FCRUTAFILE, 'http://quantum1.pendulum.com.mx/sysworkflow/es/classic/cases/cases_ShowGastos?archivo=','http://doc.pendulum.com.mx/PM/gastos/documentos/')
                                  FROM FACTURADCSOPORTE B
                                 WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                                   AND  (B.IDGASTOMAIN,B.IDCONCEPTO,B.FCCREDITO,REPLACE(FCNOMBRE, '[R]',''),3) IN
                                   (SELECT IDGASTOMAIN, IDCONCEPTO, FCCREDITO,REPLACE(FCNOMBRE, '[R]','') NOMBRE, ROW_NUMBER()
                                           OVER (PARTITION BY IDGASTOMAIN,FCCREDITO ORDER BY IDCONSEC) AS CUALES
                                           FROM FACTURADCSOPORTE
                                   )
                               )  DOCTOSOP_LINK3,
                               (SELECT REPLACE(FCNOMBRE, '[R]','')
                                  FROM FACTURADCSOPORTE B
                                 WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                                   AND  (B.IDGASTOMAIN,B.IDCONCEPTO,B.FCCREDITO,REPLACE(FCNOMBRE, '[R]',''),4) IN
                                   (SELECT IDGASTOMAIN, IDCONCEPTO, FCCREDITO,REPLACE(FCNOMBRE, '[R]','') NOMBRE, ROW_NUMBER()
                                           OVER (PARTITION BY IDGASTOMAIN,FCCREDITO ORDER BY IDCONSEC) AS CUALES
                                           FROM FACTURADCSOPORTE
                                   )
                               ) DOCTOSOP_NM4,
                               (SELECT REPLACE(FCRUTAFILE, 'http://quantum1.pendulum.com.mx/sysworkflow/es/classic/cases/cases_ShowGastos?archivo=','http://doc.pendulum.com.mx/PM/gastos/documentos/')
                                  FROM FACTURADCSOPORTE B
                                 WHERE B.IDGASTOMAIN = A.IDGASTOMAIN  AND B.IDCONCEPTO = A.IDCONCEPTO  AND B.FCCREDITO = A.FCCREDITOCARTERA
                                   AND  (B.IDGASTOMAIN,B.IDCONCEPTO,B.FCCREDITO,REPLACE(FCNOMBRE, '[R]',''),4) IN
                                   (SELECT IDGASTOMAIN, IDCONCEPTO, FCCREDITO,REPLACE(FCNOMBRE, '[R]','') NOMBRE, ROW_NUMBER()
                                           OVER (PARTITION BY IDGASTOMAIN,FCCREDITO ORDER BY IDCONSEC) AS CUALES
                                           FROM FACTURADCSOPORTE
                                   )
                               )  DOCTOSOP_LINK4
                  FROM FACTURAASIGNACION A
              ) ASIGNACION,
              (
               SELECT   DISTINCT
                        A.IDGASTOMAIN   IDGASTO,
                        TPOMOVIMIENTO   TIPOFLUJO,
                        FNNUMEMPLEADO  IDSOLICITANTE,
                        FDFECREGISTRO  FREGISTROGASTO,
                        IDSUCURSAL,
                        (SELECT CONVERT(NMSUCURSAL, 'WE8MSWIN1252','UTF8') FROM CTSUCURSALPENDULUM Y WHERE Y.IDSUCURSAL = A.IDSUCURSAL) NMSUCURSAL,
                        NVL(CASE WHEN TPOMOVIMIENTO = 'Anticipo' AND (SELECT COUNT(1)
                                                                    FROM PENDUPM.FACTURACIONBITACORA G
                                                                   WHERE A.IDGASTOMAIN = G.IDGASTOMAIN
                                                                     AND IDTASKGASTO= '656925561529384c6847c88021053266'
                                                                     AND DEL_INDEX <= DONDEESTA) >= 0 THEN 'Anticipo'
                             WHEN TPOMOVIMIENTO = 'Anticipo' AND (SELECT COUNT(1)
                                                                    FROM PENDUPM.FACTURACIONBITACORA G
                                                                   WHERE A.IDGASTOMAIN = G.IDGASTOMAIN
                                                                     AND IDTASKGASTO= '656925561529384c6847c88021053266'
                                                                     AND DEL_INDEX <= DONDEESTA) >= 0 THEN 'Anticipo-Reembolso'
                             WHEN TPOMOVIMIENTO = 'Reembolso' AND (SELECT COUNT(1)
                                                                    FROM PENDUPM.FACTURACIONBITACORA G
                                                                   WHERE A.IDGASTOMAIN = G.IDGASTOMAIN
                                                                     AND IDTASKGASTO= '656925561529384c6847c88021053266'
                                                                     AND DEL_INDEX <= DONDEESTA) >= 0 THEN 'Reembolso'
                             WHEN TPOMOVIMIENTO = 'Tramite' AND FCTIPOSOLUCION IS NOT NULL THEN 'Tramite-'||FCTIPOSOLUCION
                             WHEN TPOMOVIMIENTO = 'Tramite' AND (SELECT COUNT(1)
                                                                    FROM PENDUPM.FACTURACIONBITACORA G
                                                                   WHERE A.IDGASTOMAIN = G.IDGASTOMAIN
                                                                     AND IDTASKGASTO= '2082181485273e6002e4959086601056'
                                                                     AND DEL_INDEX <= DONDEESTA) > 0 THEN 'Tramite-Anticipo'
                             WHEN TPOMOVIMIENTO = 'Tramite' AND (SELECT COUNT(1)
                                                                    FROM PENDUPM.FACTURACIONBITACORA G
                                                                   WHERE A.IDGASTOMAIN = G.IDGASTOMAIN
                                                                     AND IDTASKGASTO= '2082181485273e6002e4959086601056'
                                                                     AND DEL_INDEX < DONDEESTA) > 0
                                                            AND (SELECT COUNT(1)
                                                                    FROM PENDUPM.FACTURACIONBITACORA G
                                                                   WHERE A.IDGASTOMAIN = G.IDGASTOMAIN
                                                                     AND IDTASKGASTO= '656925561529384c6847c88021053266'
                                                                     AND DEL_INDEX <= DONDEESTA) > 0 THEN 'Tramite-Anticipo-Reembolso'
                             WHEN TPOMOVIMIENTO = 'Tramite' AND (SELECT COUNT(1)
                                                                    FROM PENDUPM.FACTURACIONBITACORA G
                                                                   WHERE A.IDGASTOMAIN = G.IDGASTOMAIN
                                                                     AND IDTASKGASTO= '656925561529384c6847c88021053266'
                                                                     AND DEL_INDEX <= DONDEESTA) > 0 THEN 'Tramite-Reembolso'
                        END,TPOMOVIMIENTO) SUBFLUJO ,
                        CASE WHEN FCSTATUS = 'R' AND (SELECT COUNT(1) FROM PENDUPM.FACTURACIONBITACORA H
                                                       WHERE A.IDGASTOMAIN = H.IDGASTOMAIN AND IDTASKGASTO = '8961359245370cf9de08e25000253648') = 0 THEN 'REGISTRO SOLICITUD'
                             WHEN FCSTATUS = 'Z' THEN 'CANCELADO'
                             WHEN FCSTATUS = 'F' THEN 'COMPLETADO / FINALIZADO'
                             WHEN TPOMOVIMIENTO = 'Tramite' AND FCSTATUS NOT IN ('R','Z','F')   THEN 'EN GESTION DE TRAMITE'
                             WHEN TPOMOVIMIENTO != 'Tramite' AND FCSTATUS NOT IN ('R','Z','F') THEN'EN PROCESO / SOLUCION TRAMITE'
                        END STATUS ,
                        IDCONCEPTO,
                        (SELECT FCCUENTACONTABLE FROM PENDUPM.CTCATALOGOCUENTAS G WHERE G.IDCONCEPTO =A.IDCONCEPTO) CTACONTABLE,
                        (SELECT FCCUENTAINGRESOS FROM PENDUPM.CTCATALOGOCUENTAS G WHERE G.IDCONCEPTO =A.IDCONCEPTO) CTAINGRESOS,
                        A.IDCONCEPTO CONCEPTO   ,
                        (SELECT NMDESCRIP  FROM CTCUENTACATEGORIA WHERE IDCUENTACAT IN (
                           (SELECT IDCATEGORIA FROM PENDUPM.CTCATALOGOCUENTAS G WHERE G.IDCONCEPTO =A.IDCONCEPTO)
                         )) NMCATEGORIA,
                        (SELECT NMDESCRIP  FROM CTCUENTACATEGORIA WHERE IDCUENTACAT IN (
                           (SELECT IDSUBCATEGORIA FROM PENDUPM.CTCATALOGOCUENTAS G WHERE G.IDCONCEPTO =A.IDCONCEPTO)
                         )) NMDBCATEGORIA,
                        (SELECT CONVERT(NMCONCEPTO, 'WE8MSWIN1252','UTF8') FROM PENDUPM.CTCATALOGOCUENTAS G WHERE G.IDCONCEPTO =A.IDCONCEPTO) DCONCEPTO,
                        NVL(FCTIPOSOLUCION,'EXTERNO') TIPOCOSTEO,
                        IDFORMAPAGO,
                        (SELECT CONVERT(NMDESCRIPCION, 'WE8MSWIN1252','UTF8')  FROM PENDUPM.CTCATALOGOGASTOS WHERE IDCATGASTO=IDFORMAPAGO) NMFORMADEPAGO,
                        IDPROVEEDORGTO IDPROVEEDOR,
                        CONVERT(NMPROVEEDOR, 'WE8MSWIN1252','UTF8') NMPROVEEDOR,
                        FCNMPAGOCHQCAJA NMCHEQUECAJA,
                        CASE WHEN IDEMPRESAFACTURACION = 0 THEN A.IDOTEMPRESAFACTURACION
                                              WHEN (IDEMPRESAFACTURACION != 0 OR IDEMPRESAFACTURACION IS NOT NULL) THEN A.IDEMPRESAFACTURACION
                        END IDEMPRESAFACTURA,
                        (SELECT CONVERT(NMEMPRESA, 'WE8MSWIN1252','UTF8')
                           FROM PENDUPM.EMPRESAFACTURACION D
                          WHERE D.IDEMPRESA = CASE WHEN IDEMPRESAFACTURACION = 0 THEN A.IDOTEMPRESAFACTURACION
                                              WHEN (IDEMPRESAFACTURACION != 0 OR IDEMPRESAFACTURACION IS NOT NULL) THEN A.IDEMPRESAFACTURACION
                                              END
                        ) NMEMPRESAFACTURA,
                        (SELECT FNTOTAL FROM PENDUPM.FACTURACIONPAGOS P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN AND FNCONSEC = 1 ) TOTSOLICITADO,
                        (SELECT FNTOTAL FROM PENDUPM.FACTURACIONPAGOS P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN AND FNCONSEC = 2 ) TOTANTICIPO,
                        (SELECT FDFECPARAPAGO FROM PENDUPM.FACTURACIONPAGOS P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN AND FNCONSEC = 2 ) FECPAGOANTICIPO,
                        (SELECT FDFECREGISTRO  FROM PENDUPM.FACTURACIONDEPOSITO T WHERE A.IDGASTOMAIN = T.IDGASTOMAIN AND FNCONSEC = 2 AND FCSTATUS = 'A' ) FECDEPOSITOANTICIPO,
                        (SELECT FDFECDERIVACION  FROM PENDUPM.FACTURACIONDEPOSITO T WHERE A.IDGASTOMAIN = T.IDGASTOMAIN AND FNCONSEC = 2 AND FCSTATUS = 'A' ) FECCONFIRMAANTICIPO,
                        (SELECT FNIMPCOMISION  FROM PENDUPM.FACTURACIONDEPOSITO T WHERE A.IDGASTOMAIN = T.IDGASTOMAIN AND FNCONSEC = 2 AND FCSTATUS = 'A' ) COMISIONCHQANTICIPO,
                        (SELECT FCREFERENCIA  FROM PENDUPM.FACTURACIONDEPOSITO T WHERE A.IDGASTOMAIN = T.IDGASTOMAIN AND FNCONSEC = 2 AND FCSTATUS = 'A' ) REFERENCIAANTICIPO,
                        (SELECT MAX(FDFECREGISTRO)  FROM PENDUPM.FACTURACIONBITACORA F WHERE A.IDGASTOMAIN = F.IDGASTOMAIN AND (F.IDGASTOMAIN, DEL_INDEX)
                                IN (SELECT IDGASTOMAIN,MAX(DEL_INDEX) FROM PENDUPM.FACTURACIONBITACORA H WHERE  H.IDGASTOMAIN = F.IDGASTOMAIN
                                      AND IDTASKGASTO = '2147619945273e5a68478d0053334276' GROUP BY  IDGASTOMAIN
                                    )
                         ) FECHADECOMPROBACION,
                         ((SELECT FDFECREGISTRO  FROM PENDUPM.FACTURACIONDEPOSITO M WHERE A.IDGASTOMAIN = M.IDGASTOMAIN AND FNCONSEC = 2 AND FCSTATUS = 'A' ) +
                          (SELECT MIN(TIEMPOMAXCOMPROBA)  FROM CTCATALOGOCUENTAS T WHERE T.IDCONCEPTO = A.IDCONCEPTO
                                                      AND T.IDCONCEPTO IN (SELECT IDCONCEPTO FROM FACTURACIONMAIN R WHERE R.IDGASTOMAIN = A.IDGASTOMAIN
                                                                              AND T.IDCONCEPTO = A.IDCONCEPTO
                                                                          )
                                                  )
                         ) FECHAESPERADACOMPROBACION,
                        (SELECT FNTOTAL FROM PENDUPM.FACTURACIONPAGOS P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN AND FNCONSEC = 3 ) TOTCOMPROBADO,
                        (SELECT SUM(FNIMPORTE) FROM PENDUPM.FACTURACIONCOMPROBA P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN ) TOTCOMPROBAIMPBASE,
                        (SELECT SUM((FNIMPORTE*(FNIVA/100.00)*1.00)) FROM PENDUPM.FACTURACIONCOMPROBA P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN ) TOTCOMPROBAIVA,
                        (SELECT SUM(FNIVARET) FROM PENDUPM.FACTURACIONCOMPROBA P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN ) TOTCOMPROBAIVARET,
                        (SELECT SUM(FNISR) FROM PENDUPM.FACTURACIONCOMPROBA P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN ) TOTCOMPROBAISR,
                        (SELECT SUM(FNOTROSIMPUEST) FROM PENDUPM.FACTURACIONCOMPROBA P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN ) TOTCOMPROBAOTRIMP,
                        (SELECT FNTOTAL FROM PENDUPM.FACTURACIONPAGOS P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN AND FNCONSEC = 5 ) TOTDEVUELTO,
                        ((SELECT FNTOTAL FROM PENDUPM.FACTURACIONPAGOS P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN AND FNCONSEC = 3 )-
                         (SELECT FNTOTAL FROM PENDUPM.FACTURACIONPAGOS P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN AND FNCONSEC = 1 )
                        ) TOTEXCEDENTE,
                        (SELECT FNIMPORTE FROM PENDUPM.FACTURACIONPAGOS P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN AND FNCONSEC = 6 ) TOTREMBOLSO,
                        (SELECT FDFECPARAPAGO FROM PENDUPM.FACTURACIONPAGOS P WHERE A.IDGASTOMAIN = P.IDGASTOMAIN AND FNCONSEC = 6 ) FECPAGOREEMBOLSO,
                        (SELECT FDFECREGISTRO  FROM PENDUPM.FACTURACIONDEPOSITO T WHERE A.IDGASTOMAIN = T.IDGASTOMAIN AND FNCONSEC = 6 AND FCSTATUS = 'A' ) FECDEPOSITOREEMBOLSO,
                        (SELECT FDFECDERIVACION  FROM PENDUPM.FACTURACIONDEPOSITO T WHERE A.IDGASTOMAIN = T.IDGASTOMAIN AND FNCONSEC = 6 AND FCSTATUS = 'A' ) FECCONFIRMAREEMBOLSO,
                        (SELECT FNIMPCOMISION  FROM PENDUPM.FACTURACIONDEPOSITO T WHERE A.IDGASTOMAIN = T.IDGASTOMAIN AND FNCONSEC = 6 AND FCSTATUS = 'A' ) COMISIONCHQREEMBOLSO,
                        (SELECT FCREFERENCIA  FROM PENDUPM.FACTURACIONDEPOSITO T WHERE A.IDGASTOMAIN = T.IDGASTOMAIN AND FNCONSEC = 6 AND FCSTATUS = 'A' ) REFERENCIAREEMBOLSO,
                       (SELECT MAX(FCUSUARIO)  FROM PENDUPM.FACTURACIONBITACORA F WHERE A.IDGASTOMAIN = F.IDGASTOMAIN AND (F.IDGASTOMAIN, DEL_INDEX)
                                IN (SELECT IDGASTOMAIN,MAX(DEL_INDEX) FROM PENDUPM.FACTURACIONBITACORA H WHERE  H.IDGASTOMAIN = F.IDGASTOMAIN
                                      AND IDTASKGASTO = '10516340652ead549865439008696454' GROUP BY  IDGASTOMAIN
                                    )
                        ) USUARIOCONCENTRADORA ,
                       (SELECT MAX(FCUSUARIO)  FROM PENDUPM.FACTURACIONBITACORA F WHERE A.IDGASTOMAIN = F.IDGASTOMAIN AND (F.IDGASTOMAIN, DEL_INDEX)
                                IN (SELECT IDGASTOMAIN,MAX(DEL_INDEX) FROM PENDUPM.FACTURACIONBITACORA H WHERE  H.IDGASTOMAIN = F.IDGASTOMAIN
                                      AND IDTASKGASTO = '43704322352eae467857576064357523' GROUP BY  IDGASTOMAIN
                                    )
                        ) PERSONAEJECUTATRAMITE,
                       (SELECT MAX(FDFECREGISTRO)  FROM PENDUPM.FACTURACIONBITACORA F,
                                                (SELECT IDGASTOMAIN,MIN(DEL_INDEX) ESPRIMERO, MAX(DEL_INDEX) ESMAXIMO FROM PENDUPM.FACTURACIONBITACORA H WHERE
                                                IDTASKGASTO = '10516340652ead549865439008696454' GROUP BY  IDGASTOMAIN
                                                ) PREVIO
                         WHERE F.IDGASTOMAIN = A.IDGASTOMAIN AND  F.IDGASTOMAIN = PREVIO.IDGASTOMAIN
                           AND F.DEL_INDEX= (PREVIO.ESPRIMERO-1)
                        ) FECINICONCENTRADORA,
                       (SELECT MAX(FDFECREGISTRO)  FROM PENDUPM.FACTURACIONBITACORA F WHERE A.IDGASTOMAIN = F.IDGASTOMAIN AND (F.IDGASTOMAIN, DEL_INDEX)
                                IN (SELECT IDGASTOMAIN,MAX(DEL_INDEX) FROM PENDUPM.FACTURACIONBITACORA H WHERE  H.IDGASTOMAIN = F.IDGASTOMAIN
                                      AND IDTASKGASTO = '10516340652ead549865439008696454' GROUP BY  IDGASTOMAIN
                                    )
                        ) FECFINCONCENTRADORA,
                       (SELECT MAX(FDFECREGISTRO)  FROM FACTURACIONBITACORA F WHERE A.IDGASTOMAIN = F.IDGASTOMAIN AND (F.IDGASTOMAIN, DEL_INDEX)
                                IN (SELECT IDGASTOMAIN,MAX(DEL_INDEX) FROM FACTURACIONBITACORA H WHERE  H.IDGASTOMAIN = F.IDGASTOMAIN
                                      AND IDTASKGASTO = '43704322352eae467857576064357523' GROUP BY  IDGASTOMAIN
                                    )
                        ) FECHAFINEJECUCION,
                        (SELECT COUNT(1)  FROM FACTURACIONBITACORA F WHERE A.IDGASTOMAIN = F.IDGASTOMAIN AND IDTASKGASTO = '43704322352eae467857576064357523') REINCIDENCIATRAMITE,
                        CASE WHEN FCSTATUS = 'F' THEN
                            (SELECT MAX(FDFECREGISTRO)  FROM FACTURACIONBITACORA F WHERE A.IDGASTOMAIN = F.IDGASTOMAIN AND (F.DEL_INDEX)
                                    IN (SELECT MAX(DEL_INDEX) FROM FACTURACIONBITACORA H WHERE H.IDGASTOMAIN = F.IDGASTOMAIN)
                            )
                        ELSE NULL END FECHAFINGASTO,
                        DONDE.DONDEESTA NUMERORECORRIDO,
                        DONDE.NMETAPA DONDEESTAAHORITA ,
                        DONDE.FCUSUARIO QUIENLOTIENEAHORITA
                 FROM PENDUPM.FACTURACIONMAIN A INNER JOIN
                      (SELECT ZZ.IDGASTOMAIN, DONDEESTA, IDTASKGASTO TSK, FDFECREGISTRO FECACT, NMETAPA, FCUSUARIO
                         FROM PENDUPM.FACTURACIONBITACORA ZZ
                   INNER JOIN (SELECT IDGASTOMAIN,
                                     MAX (DEL_INDEX) DONDEESTA
                                 FROM PENDUPM.FACTURACIONBITACORA
                             GROUP BY IDGASTOMAIN
                              ) CC ON ( ZZ.IDGASTOMAIN = CC.IDGASTOMAIN AND DEL_INDEX = DONDEESTA)
                      ) DONDE ON ( A.IDGASTOMAIN = DONDE.IDGASTOMAIN)
                ) MAIN
        WHERE ASIGNACION.SOLICITUD = MAIN.IDGASTO
          and ASIGNACION.CONCEPTO  = MAIN.CONCEPTO
        ORDER BY ASIGNACION.SOLICITUD;
     salida := procesa;

  EXCEPTION WHEN OTHERS THEN
     NULL;

  END getExcelCuboGasto;

  PROCEDURE cargaAvaluosenLW IS

      vFolio        INTEGER     := 0;

      CURSOR cuLiberados IS
            SELECT IDGASTOMAIN, IDCONCEPTO,IDCONSEC,FCCREDITO, 'http://doc.pendulum.com.mx/PM/gastos/comiteavaluos/'||IDGASTOMAIN||'_'||FCCREDITO||'_'||IDCONSEC||'_1.pdf' CARATULA,
                   REPLACE(FCRUTAFILE, 'http://quantum1.pendulum.com.mx/sysworkflow/es/classic/cases/cases_ShowGastos?archivo=','http://doc.pendulum.com.mx/PM/gastos/documentos/') DOCTOSOPORTE,
                   '27-Avaluos Comite' CATEGORIA,
                   'Estimacion Valor Aprobada '||IDGASTOMAIN||'-'||FCCREDITO||'' REFSOPORTE ,
                   'Autorizacion Comite Valuacion '||IDGASTOMAIN||'-'||FCCREDITO||'' REFCARATULA ,
                   TO_CHAR(FDFECREGISTRO03,'DD/MM/YYYY') FECAUTORIZA,
                   'Vigente' STATUS,
                   'COMITE_VALUACION' USUARIO,
                   'SISTGASTO' PROCEDENCIA,
                   FDFECREGISTRO03
              FROM FACTURADCSOPORTE
             WHERE IDGASTOMAIN IN (SELECT IDGASTOMAIN
                                     FROM FACTURACIONBITACORA
                                    WHERE FCUSUARIO = 'kmoure@pendulum.com.mx'
                                    AND FCRESULTADO = 'Autorizado')
               AND FCRESULTADO03 = 'Correcto'
              AND ( IDGASTOMAIN, IDCONCEPTO,IDCONSEC) NOT IN (SELECT IDGASTOMAIN, IDCONCEPTO,IDCONSEC
                                                                 FROM GASTOSOPORTELW
                                                              )
            ORDER BY IDGASTOMAIN, FCCREDITO;

    BEGIN

        FOR regLibera IN cuLiberados  LOOP

         dbms_output.put_line('**APLICANDO....**::: '||regLibera.FCCREDITO||'-'||regLibera.REFCARATULA);

    --        SELECT  OPERACION.FILEGRID_SEQ.NEXTVAL INTO vFolio FROM DUAL;
    --        INSERT INTO OPERACION.FILEGRID VALUES (vFolio, regLibera.FCCREDITO,'',
    --                                               regLibera.CARATULA, regLibera.CATEGORIA,
    --                                               regLibera.REFCARATULA,
    --                                               regLibera.FECAUTORIZA, NULL,
    --                                               regLibera.STATUS,  regLibera.USUARIO, NULL, SYSDATE,
    --                                               regLibera.PROCEDENCIA , NULL,
    --                                               NULL,NULL,NULL,NULL,NULL
    --                                               );
           -- SELECT  OPERACION.FILEGRID_SEQ.NEXTVAL INTO vFolio FROM DUAL;
            INSERT INTO OPERACION.FILEGRID (
            INDICE,CREDITO,PATHDOMAIN,PATHPUBLIC,CATEGORIA,DESCRIPCION,ALTA,MODIFICADO,STATUS,USUARIORELACIONADO,IMPULSO,FECHA_ALTA,PROCEDENCIA)
            VALUES (vFolio, regLibera.FCCREDITO,'',
                                                   regLibera.CARATULA, regLibera.CATEGORIA,
                                                   regLibera.REFSOPORTE,
                                                   regLibera.FECAUTORIZA, NULL,
                                                   regLibera.STATUS,  regLibera.USUARIO, NULL, SYSDATE,
                                                   regLibera.PROCEDENCIA);

           INSERT INTO GASTOSOPORTELW VALUES (   regLibera.IDGASTOMAIN, regLibera.IDCONCEPTO, regLibera.IDCONSEC,
                                                 regLibera.FDFECREGISTRO03, regLibera.CARATULA);

        END LOOP;

        COMMIT;
     dbms_output.put_line('**EXITOSO**');
    EXCEPTION WHEN OTHERS THEN
      ROLLBACK;
     dbms_output.put_line('**error**'||SQLERRM);

  END cargaAvaluosenLW;

   PROCEDURE set_comentarios_autorizadores ( pnGasto      INTEGER,  /* numero de gasto */
                                              pnTipo       INTEGER,  /* Nuero de Alerta */
                                              pnUsuario    INTEGER,  /* Nuero de empleado */
                                              pnRespuesta  VARCHAR2, /* Respuesta si/no */
                                              pnComentario VARCHAR2, /* Comentarrio  */
                                              psError      OUT VARCHAR2)
      IS

          TYPE T_CURSOR IS REF CURSOR;
          procesa              T_CURSOR;
          psCondicion          VARCHAR2(1000)  := '';
          pdEjecuta            VARCHAR2(32000) := '';
          EXISTE               INTEGER         := 0;
          queMotivo            INTEGER         := 0;



          CURSOR numCreditos
              IS

              SELECT    A.IDCONCEPTO
                      , A.FCCREDITOCARTERA

                      FROM PENDUPM.FACTURAASIGNACION A
                      WHERE A.IDGASTOMAIN = pnGasto
                      AND
                        INSTR( CASE WHEN pnTipo  = 6 THEN (SELECT DISTINCT FCUSUUMBRAL03 FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL03 IS NOT NULL)||'|'||
                                                  (SELECT DISTINCT FCUSUUMBRAL04 FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL04 IS NOT NULL)||'|'||
                                                  (SELECT DISTINCT FCUSUUMBRAL05 FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL05 IS NOT NULL)
                              WHEN pnTipo = 7 THEN (SELECT DISTINCT FCUSUETAPA01  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAPA01 IS NOT NULL)||'|'||
                                                              (SELECT DISTINCT FCUSUETAPA02  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAPA02 IS NOT NULL)
                              WHEN pnTipo = 8 THEN (SELECT DISTINCT FCUSUPGODBL01  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPGODBL01 IS NOT NULL)||'|'||
                                                              (SELECT DISTINCT FCUSUPGODBL02  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPGODBL02 IS NOT NULL)
                              WHEN pnTipo = 9 THEN (SELECT DISTINCT FCUSUJFEINMED  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUJFEINMED IS NOT NULL  AND ROWNUM = 1)
                              WHEN pnTipo = 10 THEN (SELECT DISTINCT FCUSUEMPRESA  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEMPRESA IS NOT NULL AND ROWNUM = 1)
                              WHEN pnTipo = 34 THEN (SELECT DISTINCT FCUSUURGENTE  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUURGENTE IS NOT NULL AND ROWNUM = 1)
                              WHEN pnTipo = 41 THEN (SELECT DISTINCT FCUSUARIO  FROM PENDUPM.FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCUSUARIO IS NOT NULL)||'|'||
                                                           (SELECT DISTINCT FCUSUARIO01  FROM PENDUPM.FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCUSUARIO01 IS NOT NULL)||'|'||
                                                           (SELECT DISTINCT CASE WHEN FCUSUARIO02 = 0 THEN ''
                                                                                  ELSE FCUSUARIO02 END  FROM PENDUPM.FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN )
                              WHEN pnTipo = 44 THEN (SELECT DISTINCT FCUSUEXCGASTO01  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEXCGASTO01 IS NOT NULL)||'|'||
                                                              (SELECT DISTINCT FCUSUEXCGASTO02  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEXCGASTO02 IS NOT NULL)
                              WHEN pnTipo = 45 THEN (SELECT DISTINCT FCUSUETAFINAL01  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUETAFINAL01 IS NOT NULL)||'|'||
                                                              (SELECT DISTINCT FCUSUETAFINAL02  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAFINAL02 IS NOT NULL)
                              WHEN pnTipo = 46 THEN (SELECT DISTINCT FCUSULIQUIDADO01  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSULIQUIDADO01 IS NOT NULL)||'|'||
                                                              (SELECT DISTINCT FCUSULIQUIDADO02  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSULIQUIDADO02 IS NOT NULL)
                              WHEN pnTipo = 64 THEN (SELECT DISTINCT FCUSUNOFACT  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUNOFACT IS NOT NULL AND Z.FCESREEMBOLSABLE ='N'  AND ROWNUM = 1)
                              WHEN pnTipo = 65 THEN (SELECT DISTINCT FCUSUPM  FROM PENDUPM.FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPM IS NOT NULL  AND Z.FCESREEMBOLSABLE ='N' AND ROWNUM = 1)
                              WHEN pnTipo = 66 THEN (SELECT FCUSUARIOAUTORIZA  FROM PENDUPM.FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOAUTORIZA = 66 AND Z.FDFECAUTORIZA IS NULL )
                              WHEN pnTipo = 67 THEN (SELECT FCUSUARIOAUTORIZA  FROM PENDUPM.FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOAUTORIZA = 67)
                              WHEN pnTipo = 68 THEN (SELECT FCUSUARIOAUTORIZA  FROM PENDUPM.FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOAUTORIZA = 68)
                         ELSE  'NO EXISTE'
                         END , pnUsuario ) > 0  AND A.FCUSUPM IS NOT NULL;

      BEGIN


          FOR regLibera IN numCreditos  LOOP

              SELECT COUNT(*) TOTAL INTO EXISTE  FROM PENDUPM.ASIGNACIONCOMENTA ASIG WHERE ASIG.IDGASTOMAIN = pnGasto AND ASIG.IDCONCEPTO = regLibera.IDCONCEPTO AND ASIG.IDTIPOALARMA = pnTipo AND ASIG.IDUSUARIO = pnUsuario AND ASIG.FCCREDITOCARTERA = regLibera.FCCREDITOCARTERA;

              SELECT IDTIPOMOVTO INTO queMotivo  FROM PENDUPM.FACTURAASIGNACION FAC  WHERE FAC.IDGASTOMAIN  = pnGasto AND FAC.IDCONCEPTO = regLibera.IDCONCEPTO AND FAC.FCCREDITOCARTERA  = regLibera.FCCREDITOCARTERA;

          --Proceso para el Cometario Masivo
               IF ( EXISTE = 0) THEN
                  --Inserto el comentario en caso que no Exista
                  INSERT INTO PENDUPM.ASIGNACIONCOMENTA (IDGASTOMAIN, IDCONCEPTO, IDTIPOMOVTO, FCCREDITOCARTERA, IDTIPOALARMA, IDUSUARIO, FCCOMENTARIO, FDFECREGISTRO ) VALUES ( pnGasto, regLibera.IDCONCEPTO, queMotivo, regLibera.FCCREDITOCARTERA, pnTipo, pnUsuario, pnComentario, SYSDATE);

               ELSE
                  -- Actualizo el comentario si este ya existe
                  UPDATE PENDUPM.ASIGNACIONCOMENTA SET FCCOMENTARIO = pnComentario, FDFECREGISTRO = SYSDATE WHERE IDGASTOMAIN = pnGasto AND IDCONCEPTO = regLibera.IDCONCEPTO AND FCCREDITOCARTERA  = regLibera.FCCREDITOCARTERA AND IDTIPOALARMA = pnTipo AND IDUSUARIO = pnUsuario;
                 -- dbms_output.put_line('*** UPDATE ***  -> UPDATE PENDUPM.ASIGNACIONCOMENTA SET FCCOMENTARIO = '|| pnComentario ||', FDFECREGISTRO = SYSDATE WHERE IDGASTOMAIN = '|| pnGasto || ' AND IDCONCEPTO = '|| regLibera.IDCONCEPTO || ' AND FCCREDITOCARTERA  = ' || regLibera.FCCREDITOCARTERA  || ' AND IDTIPOALARMA = ' || pnTipo || ' AND IDUSUARIO = '|| pnUsuario || ' ' );
               END IF;

          --Proceso para la Respuesta Masiva

            UPDATE PENDUPM.FACTURAASIGNACION SET FCRESUMBRAL03  = CASE WHEN pnTipo = 6 THEN CASE WHEN FCUSUUMBRAL03 = pnUsuario THEN pnRespuesta ELSE FCRESUMBRAL03 END ELSE FCRESUMBRAL03 END,
                                       FCRESUMBRAL04  = CASE WHEN pnTipo = 6 THEN CASE WHEN FCUSUUMBRAL04 = pnUsuario THEN pnRespuesta ELSE FCRESUMBRAL04 END ELSE FCRESUMBRAL04 END,
                                       FCRESUMBRAL05  = CASE WHEN pnTipo = 6 THEN CASE WHEN FCUSUUMBRAL05 = pnUsuario THEN pnRespuesta ELSE FCRESUMBRAL05 END ELSE FCRESUMBRAL05 END,
                                       FCRESETAPA01   = CASE WHEN pnTipo = 7 THEN CASE WHEN FCUSUETAPA01 = pnUsuario THEN pnRespuesta ELSE FCRESETAPA01 END ELSE FCRESETAPA01 END,
                                       FCRESETAPA02   = CASE WHEN pnTipo = 7 THEN CASE WHEN FCUSUETAPA02 = pnUsuario THEN pnRespuesta ELSE FCRESETAPA02 END ELSE FCRESETAPA02 END,
                                       FCRESPGODBL01  = CASE WHEN pnTipo = 8 THEN CASE WHEN FCUSUPGODBL01 = pnUsuario THEN pnRespuesta ELSE FCRESPGODBL01 END ELSE FCRESPGODBL01 END,
                                       FCRESPGODBL02  = CASE WHEN pnTipo = 8 THEN CASE WHEN FCUSUPGODBL02 = pnUsuario THEN pnRespuesta ELSE FCRESPGODBL02 END ELSE FCRESPGODBL02 END,
                                       FCRESULTJFEINMED = CASE WHEN pnTipo = 9 THEN CASE WHEN FCUSUJFEINMED = pnUsuario THEN pnRespuesta ELSE FCRESULTJFEINMED END ELSE FCRESULTJFEINMED END,
                                       FCRESEMPRESA   = CASE WHEN pnTipo = 10 THEN CASE WHEN FCUSUEMPRESA = pnUsuario THEN pnRespuesta ELSE FCRESEMPRESA END ELSE FCRESEMPRESA END,
                                       FCRESURGENTE   = CASE WHEN pnTipo = 34 THEN CASE WHEN FCUSUURGENTE = pnUsuario THEN pnRespuesta ELSE FCRESURGENTE END ELSE FCRESURGENTE END,
                                       FCRESEXCGASTO01  = CASE WHEN pnTipo = 44 THEN CASE WHEN FCUSUEXCGASTO01 = pnUsuario THEN pnRespuesta ELSE FCRESEXCGASTO01 END ELSE FCRESEXCGASTO01 END,
                                       FCRESEXCGASTO02  = CASE WHEN pnTipo = 44 THEN CASE WHEN FCUSUEXCGASTO02 = pnUsuario THEN pnRespuesta ELSE FCRESEXCGASTO02 END ELSE FCRESEXCGASTO02 END,
                                       FCRESETAFINAL01  = CASE WHEN pnTipo = 45 THEN CASE WHEN FCUSUETAFINAL01 = pnUsuario THEN pnRespuesta ELSE FCRESETAFINAL01 END ELSE FCRESETAFINAL01 END,
                                       FCRESETAFINAL02  = CASE WHEN pnTipo = 45 THEN CASE WHEN FCUSUETAFINAL02 = pnUsuario THEN pnRespuesta ELSE FCRESETAFINAL02 END ELSE FCRESETAFINAL02 END,
                                       FCRESLIQ01     = CASE WHEN pnTipo = 46 THEN CASE WHEN FCUSULIQUIDADO01 = pnUsuario THEN pnRespuesta ELSE FCRESLIQ01 END ELSE FCRESLIQ01 END,
                                       FCRESLIQ02     = CASE WHEN pnTipo = 46 THEN CASE WHEN FCUSULIQUIDADO02 = pnUsuario THEN pnRespuesta ELSE FCRESLIQ02 END ELSE FCRESLIQ02 END,
                                       FCRESULTNOFACT = CASE WHEN pnTipo = 64 AND FCESREEMBOLSABLE = 'N' THEN CASE WHEN FCUSUNOFACT = pnUsuario THEN pnRespuesta ELSE FCRESULTNOFACT END ELSE FCRESULTNOFACT END,
                                       FCRESULTPM = CASE WHEN pnTipo = 65 AND FCESREEMBOLSABLE = 'N' THEN CASE WHEN FCUSUPM = pnUsuario THEN pnRespuesta ELSE FCRESULTPM END ELSE FCRESULTPM END
            WHERE IDGASTOMAIN = pnGasto AND IDCONCEPTO = regLibera.IDCONCEPTO AND FCCREDITOCARTERA  = regLibera.FCCREDITOCARTERA;



          END LOOP;

          COMMIT;

         psError := '1';
         dbms_output.put_line('*** TERMINO ***  -> '|| psError);

      EXCEPTION WHEN OTHERS THEN

       dbms_output.put_line('***ERROR*** ->'||sqlerrm);
       psError := sqlerrm;
       NULL;

      END set_comentarios_autorizadores;


      PROCEDURE get_detalle_autorizadores ( pnGasto       INTEGER,  /* numero de gasto */
                                         pnTipo        INTEGER,  /* Nuero de Alerta */
                                         pnUsuario     INTEGER,  /* Nuero de empleado */
                                         pnConcepto    INTEGER,  /* Nuero de empleado */
                                         pnCredito     VARCHAR2,  /* Nuero de empleado */
                                         salida       IN OUT T_CURSOR)
      IS

          TYPE T_CURSOR IS REF CURSOR;
          procesa               T_CURSOR;
          psCondicion           VARCHAR2(1000) := '';
          pdEjecuta             VARCHAR2(32000) := '';


      BEGIN


        SELECT   CASE WHEN pnTipo = 6 THEN ' AND FCQUEUMBRAL > 0 '
                      WHEN pnTipo = 7 THEN 'AND (VERETAPACDACHKNO IS NOT NULL OR VERETAPAABIERTANO IS NOT NULL OR FCCODACCEXTNO IS NOT NULL OR FCCODRESEXTNO IS NOT NULL)'
                      WHEN pnTipo = 8 THEN 'AND FNPAGODOBLE > 0 '
                      WHEN pnTipo= 9 THEN ' AND FCUSUJFEINMED IS NOT NULL '
                      WHEN pnTipo = 10 THEN ''
                      WHEN pnTipo = 34 THEN ''
                      WHEN pnTipo = 41 THEN ''
                      WHEN pnTipo = 44 THEN ''
                      WHEN pnTipo = 45 THEN ''
                      WHEN pnTipo = 46 THEN ' AND (FCCREDSTATUS IS NOT NULL OR FCCREDCOLA IS NOT NULL) '
                      WHEN pnTipo = 64 THEN ' AND FCUSUNOFACT IS NOT NULL '
                      WHEN pnTipo = 65 THEN ' AND FCUSUPM IS NOT NULL'
                      WHEN pnTipo = 66 THEN ''
                      WHEN pnTipo = 67 THEN ''
                      WHEN pnTipo = 68 THEN ''
                 ELSE  'NO EXISTE'
                 END CONDICION
           INTO psCondicion
          FROM DUAL;



  --       IF (pnTipo = 6 or pnTipo = 7 or pnTipo = 8 or pnTipo = 45 or pnTipo = 46) THEN

               pdEjecuta := 'SELECT ''--> ''||(SELECT NMDESCRIP  FROM CTCUENTACATEGORIA C
                           WHERE C.IDCUENTACAT = (SELECT IDCATEGORIA FROM CTCATALOGOCUENTAS H WHERE A.IDCONCEPTO = H.IDCONCEPTO))||''''||
                      '' ''||(SELECT NMDESCRIP  FROM CTCUENTACATEGORIA C
                      WHERE C.IDCUENTACAT = (SELECT IDSUBCATEGORIA FROM CTCATALOGOCUENTAS H WHERE A.IDCONCEPTO = H.IDCONCEPTO)) CATEGSUBCAT,
                      (SELECT NMCONCEPTO FROM CTCATALOGOCUENTAS B WHERE B.IDCONCEPTO = A.IDCONCEPTO) CONCEPTO, IDCONCEPTO, FCCREDITOCARTERA,
                       CASE WHEN '||pnTipo||' = 6 THEN PCKCONVENIOS.formatComas(FNIMPORTE)
                            WHEN '||pnTipo||' = 66 THEN ''Fecha ejecucion:<br /><b>''||TO_CHAR(FECHA_EJECUCION,''DD-MM-YYYY'')||''</b><br />menor a fecha solicitud:<br /><b>''||TO_CHAR(A.FDFECREGISTRO,''DD-MM-YYYY'')||''</b>''
                            WHEN '||pnTipo||' = 67 THEN ''El proveedor: <br /><b>''||(SELECT NMPROVEEDOR FROM PENDUPM.CTPROVEEDORGASTO PG WHERE PG.IDPROVEEDORGTO IN (SELECT FM.IDPROVEEDORGTO FROM PENDUPM.FACTURACIONMAIN FM WHERE FM.IDGASTOMAIN = '||pnGasto||'))||''</b> <br />no pertenece a la cuenta: <br /><b>''||A.FCCREDITOCARTERA||''</b>''
                            WHEN '||pnTipo||' = 68 THEN ''No. Tarea:<br /><b>''||A.NOTAREA||''</b><br>Categoria: <br /><b>''||(SELECT DESCRIPCION  FROM PENDUCRM.CAT_CLASIFICA_TAREA WHERE STATUS  = 1 AND TIPO = ''AB'' AND  ID IN (SELECT CLASIFICA_TAREA  FROM PENDUCRM.TAREA TAR WHERE  ID = A.NOTAREA))||''</b> <br />Estado: <br /><b>''||(SELECT DESC_EDO_TAREA FROM PENDUCRM.CAT_ESTADO_TAREA WHERE ID IN (SELECT ID_ESTADO FROM PENDUCRM.TAREA TAR WHERE  ID = A.NOTAREA))||''</b>''
                              WHEN '||pnTipo||' = 8 THEN TO_CHAR(FNPAGODOBLE)
                                                      WHEN '||pnTipo||' = 45 THEN  ''ETAPA CRR/VER: ''||VERETAPAFIN
                                                      WHEN '||pnTipo||'= 46 THEN  CASE WHEN FCCREDSTATUS IS NOT NULL THEN ''STATUS: ''||FCCREDSTATUS  END||'' ''||
                                                                                 CASE WHEN FCCREDCOLA IS NOT NULL THEN ''COLA: ''||FCCREDCOLA END
                              WHEN '||pnTipo||' = 7 THEN CASE WHEN VERETAPACDACHK IS NOT NULL THEN ''ETAPA CRR/VER: ''||VERETAPACDACHK END||'' ''||
                                                                         CASE WHEN VERETAPAABIERTA IS NOT NULL THEN ''ETAPA ABR: ''||VERETAPAABIERTA END||'' ''||
                                                                         CASE WHEN FCCODACCEXT IS NOT NULL THEN ''CA: ''||FCCODACCEXT END||'' ''||
                                                                         CASE WHEN FCCODRESEXT IS NOT NULL THEN ''CR: ''||FCCODRESEXT END
                            else ''''
                       END ALERTA,
                      FCDETALLECREDITO,
                         CASE WHEN '||pnTipo||' = 6 THEN (SELECT DISTINCT TRIM(fcjustificacionumbral) FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificacionumbral IS NOT NULL AND A.FDFECREGISTRO = Z.FDFECREGISTRO)
                              WHEN '||pnTipo||' = 7 THEN (SELECT DISTINCT TRIM(fcjustificaetapa)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificaetapa IS NOT NULL AND A.FDFECREGISTRO = Z.FDFECREGISTRO)
                              WHEN '||pnTipo||' = 8 THEN (SELECT DISTINCT TRIM(fcjustificapagodbl)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificapagodbl IS NOT NULL AND A.FDFECREGISTRO = Z.FDFECREGISTRO)
                              WHEN '||pnTipo||' = 9 THEN ''''
                              WHEN '||pnTipo||' = 10 THEN (SELECT DISTINCT TRIM(fcjustificaempresa)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificaempresa IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 34 THEN (SELECT DISTINCT TRIM(fcjustificaurgente)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificaurgente IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 41 THEN (SELECT DISTINCT FCUSUARIO FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCUSUARIO IS NOT NULL)
                              WHEN '||pnTipo||' = 44 THEN (SELECT DISTINCT TRIM(fcjustificaexcgasto)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificaexcgasto IS NOT NULL)
                              WHEN '||pnTipo||' = 45 THEN (SELECT DISTINCT TRIM(fcjustificetafinal)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificetafinal IS NOT NULL)
                              WHEN '||pnTipo||' = 46 THEN (SELECT DISTINCT TRIM(fcjustificaliq)  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcjustificaliq IS NOT NULL)
                              WHEN '||pnTipo||' = 64 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOALARMA = 65 AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 65 THEN ''''
                              WHEN '||pnTipo||' = 66 THEN (SELECT DISTINCT ALERTAFECHAEJECCOMENTARIO  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.ALERTAFECHAEJECCOMENTARIO IS NOT NULL )
                              WHEN '||pnTipo||' = 67 THEN (SELECT DISTINCT ALERTASIGNACOMENTARIO  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.ALERTASIGNACOMENTARIO IS NOT NULL )
                              WHEN '||pnTipo||' = 68 THEN (SELECT DISTINCT FCJUSTIFIACIONTAREA  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCJUSTIFIACIONTAREA IS NOT NULL )
                         ELSE  ''NO EXISTE''
                         END JUSTIFICACION,
                         CASE WHEN '||pnTipo||' = 6 THEN (SELECT DISTINCT fcresumbral03 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresumbral03 IS NOT NULL AND A.FDFECREGISTRO = Z.FDFECREGISTRO)||''|''||
                                                              (SELECT DISTINCT fcresumbral04 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresumbral04 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT fcresumbral05 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresumbral05 IS NOT NULL)
                              WHEN '||pnTipo||' = 7 THEN (SELECT DISTINCT fcresetapa01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresetapa01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT fcresetapa02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresetapa02 IS NOT NULL)
                              WHEN '||pnTipo||' = 8 THEN (SELECT DISTINCT FCRESPGODBL01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCRESPGODBL01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCRESPGODBL02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCRESPGODBL02 IS NOT NULL)
                              WHEN '||pnTipo||' = 9 THEN (SELECT DISTINCT fcresultjfeinmed  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresultjfeinmed IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 10 THEN (SELECT DISTINCT fcresempresa  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresempresa IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 34 THEN (SELECT DISTINCT fcresurgente  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.fcresurgente IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 41 THEN (SELECT DISTINCT FCRESULTADO01  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCCREDITO = A.FCCREDITOCARTERA AND Z.FCRESULTADO01 IS NOT NULL)||''|''||
                                                           (SELECT DISTINCT CASE WHEN FCUSUARIO02 = 0 THEN ''''
                                                                                  ELSE FCRESULTADO02 END  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND Z.FCCREDITO = A.FCCREDITOCARTERA)||''|''||
                                                           (SELECT DISTINCT CASE WHEN FCUSUARIO03 = 0 THEN ''''
                                                                                  ELSE FCRESULTADO03 END  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND Z.FCCREDITO = A.FCCREDITOCARTERA)
                              WHEN '||pnTipo||' = 44 THEN (SELECT DISTINCT fcresexcgasto01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresexcgasto01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT fcresexcgasto02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresexcgasto02 IS NOT NULL)
                              WHEN '||pnTipo||' = 45 THEN (SELECT DISTINCT fcresetafinal01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresetafinal01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT fcresetafinal02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresetafinal02 IS NOT NULL)
                              WHEN '||pnTipo||' = 46 THEN (SELECT DISTINCT fcresliq01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresliq01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT fcresliq02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.fcresliq02 IS NOT NULL)
                              WHEN '||pnTipo||' = 64 THEN (SELECT DISTINCT FCRESULTNOFACT  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCRESULTNOFACT IS NOT NULL AND Z.FCESREEMBOLSABLE =''N'' AND ROWNUM = 1 )
                              WHEN '||pnTipo||' = 65 THEN (SELECT DISTINCT FCRESULTPM  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCRESULTPM IS NOT NULL AND Z.FCESREEMBOLSABLE =''N'' AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 66 THEN ''Correcto''
                              WHEN '||pnTipo||' = 67 THEN ''Correcto''
                              WHEN '||pnTipo||' = 68 THEN ''Correcto''
                         ELSE  ''NO EXISTE''
                         END RESULTADOS,
                         CASE WHEN '||pnTipo||' = 6 THEN (SELECT DISTINCT FCCOMENTARIO FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUUMBRAL03 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCCOMENTARIO FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUUMBRAL04 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCCOMENTARIO FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUUMBRAL05 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)
                              WHEN '||pnTipo||' = 7 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUETAPA01 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUETAPA02 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)
                              WHEN '||pnTipo||' = 8 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUPGODBL01 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUPGODBL02 AND IDTIPOALARMA ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)
                              WHEN '||pnTipo||' = 9 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUJFEINMED AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 10 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUEMPRESA AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1 )
                              WHEN '||pnTipo||' = 34 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUURGENTE AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 41 THEN (SELECT DISTINCT FCCOMENTARIO01  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND Z.FCCREDITO = A.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO01 IS NOT NULL)||''|''||
                                                   (SELECT DISTINCT CASE WHEN FCUSUARIO02 = 0 THEN ''''
                                                                         ELSE FCCOMENTARIO02||''|'' END   FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND Z.FCCREDITO = A.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND IDTIPOMOVTO ='||pnTipo||')||
                                                   (SELECT DISTINCT CASE WHEN FCUSUARIO03 = 0 THEN ''''
                                                                         ELSE FCCOMENTARIO03 END  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND Z.FCCREDITO = A.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND IDTIPOMOVTO ='||pnTipo||')
                              WHEN '||pnTipo||' = 44 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND A.IDCONCEPTO = Z.IDCONCEPTO AND Z.IDUSUARIO = A.FCUSUEXCGASTO01 AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSUEXCGASTO02 AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)
                              WHEN '||pnTipo||' = 45 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSUETAFINAL02 AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSUETAFINAL02 AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)
                              WHEN '||pnTipo||' = 46 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSULIQUIDADO01 AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSULIQUIDADO02 AND IDTIPOMOVTO ='||pnTipo||' AND Z.FCCOMENTARIO IS NOT NULL)
                              WHEN '||pnTipo||' = 64 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSUNOFACT AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1 AND Z.IDTIPOALARMA = 64)
                              WHEN '||pnTipo||' = 65 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDUSUARIO = A.FCUSUPM AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1 AND Z.IDTIPOALARMA = 65 )
                              WHEN '||pnTipo||' = 66 THEN ''''
                              WHEN '||pnTipo||' = 67 THEN ''OK''
                              WHEN '||pnTipo||' = 68 THEN (SELECT DISTINCT FCCOMENTARIO  FROM ASIGNACIONCOMENTA Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCCOMENTARIO IS NOT NULL AND ROWNUM = 1)
                         ELSE  ''NO EXISTE''
                         END COMENTARIOS,
                         CASE WHEN '||pnTipo||' = 6 THEN (SELECT DISTINCT FCUSUUMBRAL03 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL03 IS NOT NULL)||''|''||
                                                  (SELECT DISTINCT FCUSUUMBRAL04 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL04 IS NOT NULL)||''|''||
                                                  (SELECT DISTINCT FCUSUUMBRAL05 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL05 IS NOT NULL)
                              WHEN '||pnTipo||' = 7 THEN (SELECT DISTINCT FCUSUETAPA01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAPA01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCUSUETAPA02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAPA02 IS NOT NULL)
                              WHEN '||pnTipo||' = 8 THEN (SELECT DISTINCT FCUSUPGODBL01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPGODBL01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCUSUPGODBL02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPGODBL02 IS NOT NULL)
                              WHEN '||pnTipo||' = 9 THEN (SELECT DISTINCT FCUSUJFEINMED  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUJFEINMED IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 10 THEN (SELECT DISTINCT FCUSUEMPRESA  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEMPRESA IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 34 THEN (SELECT DISTINCT FCUSUURGENTE  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUURGENTE IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 41 THEN (SELECT DISTINCT FCUSUARIO01  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCCREDITO = A.FCCREDITOCARTERA AND Z.FCUSUARIO01 IS NOT NULL)||''|''||
                                                   (SELECT DISTINCT CASE WHEN FCUSUARIO02 = 0 THEN ''''
                                                                         ELSE FCUSUARIO02||''|'' END   FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCCREDITO = A.FCCREDITOCARTERA )||
                                                   (SELECT DISTINCT CASE WHEN FCUSUARIO03 = 0 THEN ''''
                                                                         ELSE FCUSUARIO03 END  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND Z.FCCREDITO = A.FCCREDITOCARTERA)
                              WHEN '||pnTipo||' = 44 THEN (SELECT DISTINCT FCUSUEXCGASTO01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEXCGASTO01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCUSUEXCGASTO02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEXCGASTO02 IS NOT NULL)
                              WHEN '||pnTipo||' = 45 THEN (SELECT DISTINCT FCUSUETAFINAL01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUETAFINAL01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCUSUETAFINAL02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAFINAL02 IS NOT NULL)
                              WHEN '||pnTipo||' = 46 THEN (SELECT DISTINCT FCUSULIQUIDADO01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSULIQUIDADO01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCUSULIQUIDADO02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSULIQUIDADO02 IS NOT NULL)
                              WHEN '||pnTipo||' = 64 THEN (SELECT DISTINCT FCUSUNOFACT  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUNOFACT IS NOT NULL AND Z.FCESREEMBOLSABLE =''N'' AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 65 THEN (SELECT DISTINCT FCUSUPM  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPM IS NOT NULL AND Z.FCESREEMBOLSABLE =''N'' AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 66 THEN (SELECT DISTINCT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND IDTIPOAUTORIZA = 66 AND Z.FDFECAUTORIZA IS NULL )
                              WHEN '||pnTipo||' = 67 THEN (SELECT DISTINCT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND IDTIPOAUTORIZA = 67 )
                              WHEN '||pnTipo||' = 68 THEN (SELECT DISTINCT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND IDTIPOAUTORIZA = 68 )
                         ELSE  ''NO EXISTE''
                         END USUARIOS,TO_CHAR(FDFECREGISTRO, ''DDMMYYYYHH24MISS'') FECHAREGISTRO
                      FROM FACTURAASIGNACION A WHERE IDGASTOMAIN = '||pnGasto||' AND
                        INSTR( CASE WHEN '||pnTipo||' = 6 THEN (SELECT DISTINCT FCUSUUMBRAL03 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL03 IS NOT NULL)||''|''||
                                                  (SELECT DISTINCT FCUSUUMBRAL04 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL04 IS NOT NULL)||''|''||
                                                  (SELECT DISTINCT FCUSUUMBRAL05 FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUUMBRAL05 IS NOT NULL)
                              WHEN '||pnTipo||' = 7 THEN (SELECT DISTINCT FCUSUETAPA01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAPA01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCUSUETAPA02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAPA02 IS NOT NULL)
                              WHEN '||pnTipo||' = 8 THEN (SELECT DISTINCT FCUSUPGODBL01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPGODBL01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCUSUPGODBL02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPGODBL02 IS NOT NULL)
                              WHEN '||pnTipo||' = 9 THEN (SELECT DISTINCT FCUSUJFEINMED  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUJFEINMED IS NOT NULL  AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 10 THEN (SELECT DISTINCT FCUSUEMPRESA  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN  AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEMPRESA IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 34 THEN (SELECT DISTINCT FCUSUURGENTE  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUURGENTE IS NOT NULL AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 41 THEN (SELECT DISTINCT FCUSUARIO  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCUSUARIO IS NOT NULL)||''|''||
                                                           (SELECT DISTINCT FCUSUARIO01  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND Z.FCUSUARIO01 IS NOT NULL)||''|''||
                                                           (SELECT DISTINCT CASE WHEN FCUSUARIO02 = 0 THEN ''''
                                                                                  ELSE FCUSUARIO02 END  FROM FACTURADCSOPORTE Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN )
                              WHEN '||pnTipo||' = 44 THEN (SELECT DISTINCT FCUSUEXCGASTO01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEXCGASTO01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCUSUEXCGASTO02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUEXCGASTO02 IS NOT NULL)
                              WHEN '||pnTipo||' = 45 THEN (SELECT DISTINCT FCUSUETAFINAL01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND FCUSUETAFINAL01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCUSUETAFINAL02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUETAFINAL02 IS NOT NULL)
                              WHEN '||pnTipo||' = 46 THEN (SELECT DISTINCT FCUSULIQUIDADO01  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSULIQUIDADO01 IS NOT NULL)||''|''||
                                                              (SELECT DISTINCT FCUSULIQUIDADO02  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSULIQUIDADO02 IS NOT NULL)
                              WHEN '||pnTipo||' = 64 THEN (SELECT DISTINCT FCUSUNOFACT  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUNOFACT IS NOT NULL AND Z.FCESREEMBOLSABLE =''N''  AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 65 THEN (SELECT DISTINCT FCUSUPM  FROM FACTURAASIGNACION Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN   AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.FCUSUPM IS NOT NULL  AND Z.FCESREEMBOLSABLE =''N'' AND ROWNUM = 1)
                              WHEN '||pnTipo||' = 66 THEN (SELECT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOAUTORIZA = 66 AND Z.FDFECAUTORIZA IS NULL )
                              WHEN '||pnTipo||' = 67 THEN (SELECT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOAUTORIZA = 67)
                              WHEN '||pnTipo||' = 68 THEN (SELECT FCUSUARIOAUTORIZA  FROM FACTURACIONAUT Z WHERE A.IDGASTOMAIN = Z.IDGASTOMAIN AND A.FCCREDITOCARTERA = Z.FCCREDITOCARTERA AND Z.IDTIPOAUTORIZA = 68)
                         ELSE  ''NO EXISTE''
                         END , '||''''||pnUsuario||''''||') > 0 AND FCCREDITOCARTERA = ''' || pnCredito || ''' AND IDCONCEPTO = '|| pnConcepto || ' '||psCondicion ;


         dbms_output.put_line('....'||pdEjecuta);

         OPEN procesa FOR pdEjecuta;
         salida := procesa;


      EXCEPTION WHEN OTHERS THEN

       dbms_output.put_line('***ERROR*** ->'||sqlerrm);
       NULL;

      END get_detalle_autorizadores;





      PROCEDURE set_detalle_autorizadores ( pnGasto       INTEGER,  /* numero de gasto */
                                            pnTipo        INTEGER,  /* Numero de Alerta */
                                            pnUsuario     INTEGER,  /* Numero de empleado */
                                            pnConcepto    INTEGER,  /* Numero de Concepto */
                                            pnCredito     VARCHAR2,  /* Numero de Credito */
                                            pnComentario  VARCHAR2,  /* Comentario */
                                            pnRespuesta   VARCHAR2,  /* Respuesta  */
                                            psError        OUT VARCHAR2)
      IS

          TYPE T_CURSOR IS REF CURSOR;
          procesa              T_CURSOR;
          psCondicion          VARCHAR2(1000)  := '';
          pdEjecuta            VARCHAR2(32000) := '';
          EXISTE               INTEGER         := 0;
          queMotivo            INTEGER         := 0;





      BEGIN

              SELECT COUNT(*) TOTAL INTO EXISTE  FROM PENDUPM.ASIGNACIONCOMENTA ASIG WHERE ASIG.IDGASTOMAIN = pnGasto AND ASIG.IDCONCEPTO = pnConcepto AND ASIG.IDTIPOALARMA = pnTipo AND ASIG.IDUSUARIO = pnUsuario AND ASIG.FCCREDITOCARTERA = pnCredito;

              SELECT IDTIPOMOVTO INTO queMotivo  FROM PENDUPM.FACTURAASIGNACION FAC  WHERE FAC.IDGASTOMAIN  = pnGasto AND FAC.IDCONCEPTO = pnConcepto AND FAC.FCCREDITOCARTERA  = pnCredito;

          --Proceso para el Cometario Masivo
               IF ( EXISTE = 0) THEN
                  --Inserto el comentario en caso que no Exista
                  INSERT INTO PENDUPM.ASIGNACIONCOMENTA (IDGASTOMAIN, IDCONCEPTO, IDTIPOMOVTO, FCCREDITOCARTERA, IDTIPOALARMA, IDUSUARIO, FCCOMENTARIO, FDFECREGISTRO ) VALUES ( pnGasto, pnConcepto, queMotivo, pnCredito, pnTipo, pnUsuario, pnComentario, SYSDATE);

               ELSE
                  -- Actualizo el comentario si este ya existe
                  UPDATE PENDUPM.ASIGNACIONCOMENTA SET FCCOMENTARIO = pnComentario, FDFECREGISTRO = SYSDATE WHERE IDGASTOMAIN = pnGasto AND IDCONCEPTO = pnConcepto AND FCCREDITOCARTERA  = pnCredito AND IDTIPOALARMA = pnTipo AND IDUSUARIO = pnUsuario;
                  dbms_output.put_line('*** UPDATE ***  -> UPDATE PENDUPM.ASIGNACIONCOMENTA SET FCCOMENTARIO = '|| pnComentario ||', FDFECREGISTRO = SYSDATE WHERE IDGASTOMAIN = '|| pnGasto || ' AND IDCONCEPTO = '|| pnConcepto || ' AND FCCREDITOCARTERA  = ' || pnCredito  || ' AND IDTIPOALARMA = ' || pnTipo || ' AND IDUSUARIO = '|| pnUsuario || ' ' );
               END IF;

          --Proceso para la Respuesta Masiva

            UPDATE PENDUPM.FACTURAASIGNACION SET FCRESUMBRAL03  = CASE WHEN pnTipo = 6 THEN CASE WHEN FCUSUUMBRAL03 = pnUsuario THEN pnRespuesta ELSE FCRESUMBRAL03 END ELSE FCRESUMBRAL03 END,
                                       FCRESUMBRAL04  = CASE WHEN pnTipo = 6 THEN CASE WHEN FCUSUUMBRAL04 = pnUsuario THEN pnRespuesta ELSE FCRESUMBRAL04 END ELSE FCRESUMBRAL04 END,
                                       FCRESUMBRAL05  = CASE WHEN pnTipo = 6 THEN CASE WHEN FCUSUUMBRAL05 = pnUsuario THEN pnRespuesta ELSE FCRESUMBRAL05 END ELSE FCRESUMBRAL05 END,
                                       FCRESETAPA01   = CASE WHEN pnTipo = 7 THEN CASE WHEN FCUSUETAPA01 = pnUsuario THEN pnRespuesta ELSE FCRESETAPA01 END ELSE FCRESETAPA01 END,
                                       FCRESETAPA02   = CASE WHEN pnTipo = 7 THEN CASE WHEN FCUSUETAPA02 = pnUsuario THEN pnRespuesta ELSE FCRESETAPA02 END ELSE FCRESETAPA02 END,
                                       FCRESPGODBL01  = CASE WHEN pnTipo = 8 THEN CASE WHEN FCUSUPGODBL01 = pnUsuario THEN pnRespuesta ELSE FCRESPGODBL01 END ELSE FCRESPGODBL01 END,
                                       FCRESPGODBL02  = CASE WHEN pnTipo = 8 THEN CASE WHEN FCUSUPGODBL02 = pnUsuario THEN pnRespuesta ELSE FCRESPGODBL02 END ELSE FCRESPGODBL02 END,
                                       FCRESULTJFEINMED = CASE WHEN pnTipo = 9 THEN CASE WHEN FCUSUJFEINMED = pnUsuario THEN pnRespuesta ELSE FCRESULTJFEINMED END ELSE FCRESULTJFEINMED END,
                                       FCRESEMPRESA   = CASE WHEN pnTipo = 10 THEN CASE WHEN FCUSUEMPRESA = pnUsuario THEN pnRespuesta ELSE FCRESEMPRESA END ELSE FCRESEMPRESA END,
                                       FCRESURGENTE   = CASE WHEN pnTipo = 34 THEN CASE WHEN FCUSUURGENTE = pnUsuario THEN pnRespuesta ELSE FCRESURGENTE END ELSE FCRESURGENTE END,
                                       FCRESEXCGASTO01  = CASE WHEN pnTipo = 44 THEN CASE WHEN FCUSUEXCGASTO01 = pnUsuario THEN pnRespuesta ELSE FCRESEXCGASTO01 END ELSE FCRESEXCGASTO01 END,
                                       FCRESEXCGASTO02  = CASE WHEN pnTipo = 44 THEN CASE WHEN FCUSUEXCGASTO02 = pnUsuario THEN pnRespuesta ELSE FCRESEXCGASTO02 END ELSE FCRESEXCGASTO02 END,
                                       FCRESETAFINAL01  = CASE WHEN pnTipo = 45 THEN CASE WHEN FCUSUETAFINAL01 = pnUsuario THEN pnRespuesta ELSE FCRESETAFINAL01 END ELSE FCRESETAFINAL01 END,
                                       FCRESETAFINAL02  = CASE WHEN pnTipo = 45 THEN CASE WHEN FCUSUETAFINAL02 = pnUsuario THEN pnRespuesta ELSE FCRESETAFINAL02 END ELSE FCRESETAFINAL02 END,
                                       FCRESLIQ01     = CASE WHEN pnTipo = 46 THEN CASE WHEN FCUSULIQUIDADO01 = pnUsuario THEN pnRespuesta ELSE FCRESLIQ01 END ELSE FCRESLIQ01 END,
                                       FCRESLIQ02     = CASE WHEN pnTipo = 46 THEN CASE WHEN FCUSULIQUIDADO02 = pnUsuario THEN pnRespuesta ELSE FCRESLIQ02 END ELSE FCRESLIQ02 END,
                                       FCRESULTNOFACT = CASE WHEN pnTipo = 64 AND FCESREEMBOLSABLE = 'N' THEN CASE WHEN FCUSUNOFACT = pnUsuario THEN pnRespuesta ELSE FCRESULTNOFACT END ELSE FCRESULTNOFACT END,
                                       FCRESULTPM = CASE WHEN pnTipo = 65 AND FCESREEMBOLSABLE = 'N' THEN CASE WHEN FCUSUPM = pnUsuario THEN pnRespuesta ELSE FCRESULTPM END ELSE FCRESULTPM END
            WHERE IDGASTOMAIN = pnGasto AND IDCONCEPTO = pnConcepto AND FCCREDITOCARTERA  = pnCredito;

          COMMIT;

         psError := '1';
         dbms_output.put_line('*** TERMINO ***  -> '|| psError);

      EXCEPTION WHEN OTHERS THEN

       dbms_output.put_line('***ERROR*** ->'||sqlerrm);
       psError := sqlerrm;
       NULL;

      END set_detalle_autorizadores;



  END;
  /
